\documentclass[11pt,a4paper]{report}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                                                 %%
%%    Header file for the Phi-S-X Series                           %%
%%                                                                 %%
%%    german version header_gm.tex is derived from header.tex      %%
%%    by uncommenting the line ``\setboolean{german}{true}'' below %%
%%                                                                 %%
%%    Never edit the german version! all changes must be done      %%
%%    in the english version header.tex                            %%
%%                                                                 %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{../header}
\hypersetup{pdftitle=paw_brillouin}
\begin{document}
\begin{titlepage}
\begin{center}
\vspace*{3.5cm}
{\huge \textbf{The LMTO object of the CP-PAW code}}\\
\vspace{0.5cm}
{\large Peter E. Bl\"ochl}
\vspace{0.5cm} 
\end{center}

\vfill
\begin{center}
Copyright Peter E. Bl\"ochl; Sept.2, 2013-\today\\
{\small
Institute of Theoretical Physics;
Clausthal University of Technology;\\ 
D-38678 Clausthal Zellerfeld; Germany;\\
http://www.pt.tu-clausthal.de/atp/}
\end{center}
\end{titlepage}
\noindent            
\tableofcontents
%====================================================================
\chapter{Todo}
%====================================================================
\begin{itemize}
\item lmto\_overlapphi calculates the onsite overlap matrix of partial
  waves in a sphere.
%
\item the core-valence exchange contribution differs from the old version,
  because it also includes the projection on the phidot functions.
\end{itemize}

%====================================================================
\chapter{Purpose and theoretical background of the LMTO Object}
%====================================================================
The LMTO object maps the wave functions expressed in augmented plane
waves into a basiset of natural tight-binding orbitals. The natural
tight-binding orbitals are a kind of LMTO's, screened such that the
tails exhibit only scattering character in the context of nodeless
wave functions\cite{bloechl12_arxiv1210_5937}.

%====================================================================
\section{Structure constants}
%====================================================================
%====================================================================
\subsection{Bare structure constants}
%====================================================================
The bare structure constants are the expansion constants for an
off-site expansion of solid spherical Hankel functions\index{Hankel
  function}.
\begin{eqnarray}
|K_{\alpha}^\infty\rangle=|K^\Omega_{\alpha}\rangle
-\sum_{\beta}|J^\Omega_{\beta}\rangle S^\dagger_{\beta,\alpha}
+|K^I_{\alpha}\rangle
\end{eqnarray}
The index $\alpha$ denotes here an atomic site $R$ and a set of
angular momenta $L=(\ell,m)$.

The superscript $\infty$ denotes that the function extends over all
space, a superscript $\Omega$ denotes that the function is truncated
(set to zero) outside the augmentation sphere $\Omega_{R}$ centerd at
the site denoted by the index. The superscript $I$ denotes that the
function is limited to the interstitial region, that is outside all
augmentation spheres. If the augmentation spheres overlap, the
function in the interstitial region is defined by subtraction of all
sphere contributions.

In the following we will call $|K^\Omega_{\alpha}\rangle$ \textbf{head
  function}\index{head function} and $|J^\Omega_{\beta}\rangle$
\textbf{tail functions}\index{tail function}.


%====================================================================
\subsection{Screened structure constants}
%====================================================================
The node-less scattering partial wave
$|\dot{\bar{\phi}}_\alpha\rangle$ define the screening constants
$\bar{Q}_{\alpha}$ such that the screened tail functions
$|\bar{J}_\alpha\rangle$ match with value and derivative to the
scattering partial wave
\begin{eqnarray}
|\dot{\bar{\phi}}_\alpha\rangle \rightarrow 
|\bar{J}^{\Omega}_{\alpha}\rangle
\defas
|\bar{J}^{\Omega}_{\alpha}\rangle
-|\bar{K}^{\Omega}_{\alpha}\rangle \bar{Q}_{\alpha}
\end{eqnarray}

A screened Hankel functions is a superposition of bare Hankel
functions on a set of atomic positions withe the property that the
tail functions are made entirely from screened bessel functions, i.e.
\begin{eqnarray}
|\bar{K}_{\alpha}^\infty\rangle=|K^\Omega_{\alpha}\rangle
-\sum_{\beta}|\bar{J}^\Omega_{\beta}\rangle \bar{S}^\dagger_{\beta,\alpha}
+|\bar{K}^I_{\alpha}\rangle
\label{eq:kbarwithsbar}
\end{eqnarray}

The screened Hankel functions are defined by a superposition of bare
Hankel functions
\begin{eqnarray}
|\bar{K}^\infty_\alpha\rangle=\sum_\beta|K^\infty_\beta\rangle c_{\beta,\alpha}
\label{eq:kbarassuperposofkbare}
\end{eqnarray}

By equating the two expressiones for the screened Hankel functions,
namely \eq{eq:kbarassuperposofkbare} and \eq{eq:kbarwithsbar}, we can
extract the screened structure constants and the superposition
coeffcients.
\begin{eqnarray}
\sum_\beta\Bigl[|K^\Omega_{\beta}\rangle
-\sum_{\gamma}|J^\Omega_{\gamma}\rangle S^\dagger_{\gamma,\beta}
+|K^I_{\beta}\rangle \Bigr]c_{\beta,\alpha}
=
|K^\Omega_{\alpha}\rangle
-\sum_{\beta}
\underbrace{\Bigl[|J^\Omega_{\beta}\rangle-|K^\Omega_{\beta}\rangle\bar{Q}_\beta\Bigr]}
_{|\bar{J}^\Omega_{\beta}\rangle} \bar{S}^\dagger_{\beta,\alpha}
+|\bar{K}^I_{\alpha}\rangle
\nonumber\\
\sum_\beta
|K^\Omega_{\beta}\rangle c_{\beta,\alpha}
-\sum_{\beta,\gamma}|J^\Omega_{\gamma}\rangle S^\dagger_{\gamma,\beta} c_{\beta,\alpha}
%+\sum_\beta|K^I_{\beta}\rangle c_{\beta,\alpha}
=
\sum_{\beta}|K^\Omega_{\beta}\rangle
\Bigl[\delta_{\beta,\alpha}+
\bar{Q}_\beta \bar{S}^\dagger_{\beta,\alpha}\Bigr]
-\sum_{\beta}|J^\Omega_{\beta}\rangle \bar{S}^\dagger_{\beta,\alpha}
%+|\bar{K}^I_{\alpha}\rangle
\end{eqnarray}
By comparing the coefficients, we obtain
\begin{eqnarray}
c_{\beta,\alpha}&=&\delta_{\beta,\alpha}+
\bar{Q}_\beta \bar{S}^\dagger_{\beta,\alpha}
\nonumber\\
\bar{S}^\dagger_{\gamma,\alpha}&=&\sum_\beta S^\dagger_{\gamma,\beta} c_{\beta,\alpha}
\label{eq:definingeqsystemforsbar}
\end{eqnarray}
which can be resolved to\footnote{
\begin{eqnarray}
\mat{c}&=&\mat{1}
+\mat{\bar{Q}}\mat{\bar{S}}^\dagger
=\mat{1}+\mat{\bar{Q}}\mat{S}^\dagger\mat{c}
\qquad
\Rightarrow\qquad\sum_\gamma \Bigl[\delta_{\beta,\gamma}
-\bar{Q}_\beta S^\dagger_{\beta,\gamma}\Bigr] c_{\gamma,\alpha}=\delta_{\beta,\alpha}
\qquad\Rightarrow\qquad
\mat{c}=[\mat{1}-\mat{\bar{Q}}\mat{S}^\dagger]^{-1}
\nonumber\\
\mat{\bar{S}}^\dagger&=&\mat{S}^\dagger\mat{c}
=\mat{S}^\dagger[\mat{1}-\mat{\bar{Q}}\mat{S}^\dagger]^{-1}
\qquad\Leftrightarrow\qquad
[\mat{1}-\mat{S}\mat{\bar{Q}}]\mat{\bar{S}}=\mat{S}
\end{eqnarray}
The calculation can be done on a cluster of atomic sites for a single
screened Hankel function. That is, $\alpha$ in
\eq{eq:definingeqsystemforsbar} may be a single fixed orbital index,
while the indices $\beta,\gamma$ can take any value on the
cluster. Thus, $\bar{S}^\dagger$ and the coefficients $c$ can be considered as
vectors $\vec{s}$ and $\vec{c}$.
\begin{eqnarray}
\vec{c}_\alpha&=&\vec{e}_\alpha+\mat{\bar{Q}}\vec{s}_\alpha
=\vec{e}_\alpha+\mat{\bar{Q}}\mat{S}^\dagger\vec{c}_\alpha
\qquad
\Bigl[\mat{1}-\mat{\bar{Q}}\mat{S}^\dagger\Bigr]\vec{c}_\alpha=\vec{e}_\alpha
\qquad\Rightarrow\qquad
\mat{c}_\alpha=[\mat{1}-\mat{\bar{Q}}\mat{S}^\dagger]^{-1}\vec{e}_\alpha
\nonumber\\
\vec{s}_\alpha&=&\mat{S}^\dagger\vec{c}_\alpha
=\mat{S}^\dagger[\mat{1}-\mat{\bar{Q}}\mat{S}^\dagger]^{-1}\vec{e}_\alpha
\end{eqnarray}
Thus we first evaluate $\mat{S}^\dagger$ on the cluster, and from that
$[\mat{1}-\mat{\bar{Q}}\mat{S}^\dagger]$. Then we solve the equation
\begin{eqnarray}
[\mat{1}-\mat{\bar{Q}}\mat{S}^\dagger]\vec{q}_\alpha=\vec{e}_\alpha
\end{eqnarray}
for $\vec{q}_\alpha$.  Multiplication with te bare structure constants
yields the screened structure constants as
$\vec{s}_\alpha=\mat{S}^\dagger\vec{q}_\alpha$.  } the defining
equation of the screened structure constants
\begin{eqnarray}
\mat{\bar{S}}^\dagger=\mat{S}^\dagger
\Bigl[\mat{1}-\mat{\bar{Q}}\mat{S}^\dagger\Bigr]^{-1}
\end{eqnarray}
and the expression of the screened Hankel functions 
\begin{eqnarray}
|\bar{K}^\infty_\alpha\rangle=\sum_\beta |K^\infty_\beta\rangle
\Bigl[\delta_{\beta,\alpha}+
\bar{Q}_\beta \bar{S}^\dagger_{\beta,\alpha}\Bigr]
\;.
\end{eqnarray}




%====================================================================
\section{Augmentation and Potential parameters}
%====================================================================
%===============================================================================
\subsection{Local orbitals}
%===============================================================================
The local orbitals have the form
\begin{eqnarray}
|\chi_\alpha\rangle&=&|\phi^K_\alpha\rangle
- |\phi^{\bar{J}}_{R,L}\rangle \bar{S}^\dagger_{R,L,R_\alpha,L_\alpha}
\nonumber\\
&+&|K^\infty_{R',L'}\rangle\Bigl[ \delta_{R',L',R_\alpha,\L_\alpha}-\bar{Q}_{R',L'}
\bar{S}^\dagger_{R',L',R_\alpha,L_\alpha}\Bigr]
\end{eqnarray}
where, according to \eq{eq:tborbinlmto},
\begin{eqnarray}
|\phi^K_\alpha\rangle&=&
\overbrace{
|\phi_\alpha\rangle 
\underbrace{
\frac{W_\alpha[K,\dot{\bar{\phi}}]}{W_\alpha[\phi,\dot{\bar{\phi}}]}}_{Ktophi}
-\,|\dot{\bar{\phi}}_\alpha\rangle 
\underbrace{\frac{W_\alpha[K,\phi]}{W_\alpha[\phi,\dot{\bar{\phi}}]}}_{-Ktophidot}
}^{\rightarrow |K^\Omega_\alpha\rangle}
\nonumber\\
|\phi^{\bar{J}}_{R,L}\rangle
&=&\overbrace{
|\dot{\bar{\phi}}_\beta\rangle 
\underbrace{\biggl(-\frac{W_\beta[\bar{J},\phi]}{W_\beta[\phi,\dot{\bar{\phi}}]}\biggr)}_{JBARtophidot}
}^{\rightarrow |\bar{J}\;^\Omega_\beta\rangle}
\end{eqnarray}
Note that in the factor $JBARTOPHIDOT$ does not depend on the choice
of $|\phi\rangle$.

Thus, the matrix elements
$\langle\tilde{p}_\gamma|\tilde{\chi}_\alpha\rangle$ has the form
\begin{eqnarray}
\langle\tilde{p}_\gamma|\tilde{\chi}_\alpha\rangle
=\langle\tilde{p}_\gamma|\tilde{\phi}^K_\alpha\rangle
-\sum_{R',L'}\langle\tilde{p}_\gamma|\tilde{\phi}^{\bar{J}}_{R',L'}\rangle
\bar{S}^\dagger_{R,L,R_\alpha,L_\alpha}
\nonumber\\
=\langle\tilde{p}_\gamma|\tilde{\phi}^K_\alpha\rangle
-\langle\tilde{p}_\gamma|\tilde{\phi}^{\bar{J}}_{R_\gamma,L_\gamma}\rangle
\bar{S}^\dagger_{R_\gamma,L_\gamma,R_\alpha,L_\alpha}
\end{eqnarray}
%====================================================================
\section{Coefficients of the tight-binding orbital}
%====================================================================
%===============================================================================
\subsection{Introduction}
%===============================================================================
In this section we describe how to determine the wave functions in
terms of local orbitals, if the projections onto the pseudo wave
functions are known.

The basic idea is to find a representation of the wave function in
local orbitals
\begin{eqnarray}
|\psi'_n\rangle=\sum_\alpha |\chi_\alpha\rangle q_\alpha\;,
\end{eqnarray}
such that the deviation from the true wave function $|\psi_n\rangle$
is as small as possible.

Ideally this would amount to minimizing
\begin{eqnarray*}
Q[\vec{q}]:=\Bigl(\langle\psi_n|-\sum_\alpha q^*_\alpha\langle\chi_\alpha|\Bigr)
\Bigl(|\psi_n\rangle-\sum_\alpha |\chi_\beta\rangle q_\beta\Bigr)
\end{eqnarray*}
takes a minimum.

Because evaluating the mean square deviation as integral over all
space we limit the integral to the augmentation spheres.
\begin{eqnarray}
Q[\vec{q}]&:=&
\Bigl(\langle\tilde{\psi}_n|
-\sum_\alpha q^*_\alpha\langle\tilde{\chi}_\alpha|\Bigr)
\biggl[\sum_{\delta,\gamma}|\tilde{p}_\delta\rangle\langle\phi_\delta|
\theta_{\Omega_{R_\delta}}|\phi_\gamma\rangle\langle\tilde{p}_\gamma|\biggr]
\Bigl(|\tilde{\psi}_n\rangle
-\sum_\beta |\tilde{\chi}_\beta\rangle q_\beta\Bigr)
\nonumber\\
&=&
\sum_{\gamma}
\biggl[
\sum_{\delta}
\Bigl(\langle\tilde{\psi}_n|\tilde{p}_\delta\rangle
-\sum_\alpha q^*_\alpha\langle\tilde{\chi}_\alpha|\tilde{p}_\delta\rangle\Bigr)
\langle\phi_\delta|\theta_{\Omega_{R_\delta}}|\phi_\gamma\rangle
\biggr]
\Bigl(\langle\tilde{p}_\gamma|\tilde{\psi}_n\rangle
-\sum_\beta \langle\tilde{p}_\gamma|\tilde{\chi}_\beta\rangle q_\beta\Bigr)
\end{eqnarray}
where $\theta_{\Omega_{R_\delta}}$ is a step function that vanishes
outside the augmentation sphere at $R_\delta$.

Minimization yields
\begin{eqnarray}
\frac{\partial Q}{\partial q^*_\alpha}
&=&
-\sum_{\gamma}
\biggl[
\sum_{\delta}
\langle\tilde{\chi}_\alpha|\tilde{p}_\delta\rangle
\langle\phi_\delta|\theta_{\Omega_{R_\delta}}|\phi_\gamma\rangle
\biggr]
\Bigl(\langle\tilde{p}_\gamma|\tilde{\psi}_n\rangle
-\sum_\beta \langle\tilde{p}_\gamma|\tilde{\chi}_\beta\rangle q_\beta\Bigr)
\stackrel{!}{=}0
\nonumber
\end{eqnarray}


\begin{eqnarray}
\Rightarrow\qquad\sum_{\gamma}
\biggl[
\sum_{\delta}
\langle\tilde{\chi}_\alpha|\tilde{p}_\delta\rangle
\langle\phi_\delta|\theta_{\Omega_{R_\delta}}|\phi_\gamma\rangle
\biggr]
\langle\tilde{p}_\gamma|\tilde{\psi}_n\rangle
=
\sum_{\gamma,\beta}
\biggl[
\sum_{\delta}
\langle\tilde{\chi}_\alpha|\tilde{p}_\delta\rangle
\langle\phi_\delta|\theta_{\Omega_{R_\delta}}|\phi_\gamma\rangle
\biggr]
\langle\tilde{p}_\gamma|\tilde{\chi}_\beta\rangle q_\beta\Bigr)
\nonumber
\end{eqnarray}

\begin{eqnarray}
\Rightarrow\qquad
q_\beta=
\sum_{\beta}
\biggl[
\sum_{\gamma',\delta'}
\langle\tilde{\chi}_\alpha|\tilde{p}_{\delta'}\rangle
\langle\phi_{\delta'}|\theta_{\Omega_{R_\delta}}|\phi_{\gamma'}\rangle
\langle\tilde{p}_{\gamma'}|\tilde{\chi}_\beta\rangle 
\biggr]^{-1}
\biggl[
\sum_{\gamma\delta}
\langle\tilde{\chi}_\alpha|\tilde{p}_\delta\rangle
\langle\phi_\delta|\theta_{\Omega_{R_\delta}}|\phi_\gamma\rangle
\biggr]
\langle\tilde{p}_\gamma|\tilde{\psi}_n\rangle
\nonumber\\
\end{eqnarray}


This allows one to write the wave function in the form
\begin{eqnarray}
|\psi_n\rangle\approx
\sum_\alpha|\chi_\alpha\rangle\langle\tilde{\pi}_\alpha|\tilde{\psi}_n\rangle
\end{eqnarray}
with
\begin{eqnarray}
\langle\tilde{\pi}_\alpha|=
\sum_\gamma \biggl[
\sum_{\gamma',\delta'}
\langle\tilde{\chi}_\alpha|\tilde{p}_{\delta'}\rangle
\langle\phi_{\delta'}|\theta_{\Omega_{R_\delta}}|\phi_{\gamma'}\rangle
\langle\tilde{p}_{\gamma'}|\tilde{\chi}_\beta\rangle 
\biggr]^{-1}
\biggl[
\sum_{\delta}
\langle\tilde{\chi}_\alpha|\tilde{p}_\delta\rangle
\langle\phi_\delta|\theta_{\Omega_{R_\delta}}|\phi_\gamma\rangle
\biggr]
\langle\tilde{p}_\gamma|
\label{eq:pitilde}
\end{eqnarray}

This expression works also if the number of local orbitals
$|\chi_\alpha\rangle$ is smaller than the number of projector
functions $\langle{p}_\gamma|$. Because of the inversion, this
expression needs to be evaluated in reciprocal space.

%===============================================================================
\subsection{Transformation between local-orbital and partial-wave projections}
%===============================================================================
In the previous section we derived in \eq{eq:pitilde} a relation
between orbital and partial wave projector functions.
\begin{eqnarray}
\langle\tilde{\pi}_\alpha|\tilde{\psi}_n\rangle
&=&\sum_\beta M_{\alpha,\beta}\langle\tilde{p}_\alpha|\tilde{\psi}_n\rangle
\end{eqnarray}
This operation is performed in \verb|lmto$projtontbo| with \verb|ID='FWRD'|


The derivatives are correspondingly derived as 
\begin{eqnarray}
dE
&=&
\sum_{\alpha,n}\frac{\partial E}{\partial \langle\tilde{\pi}_\alpha|\tilde{\psi}_n\rangle}
d\langle\tilde{\pi}_\alpha|\tilde{\psi}_n\rangle
\nonumber\\
&=&
\sum_{\alpha,\beta,n}\frac{\partial E}
{\partial \langle\tilde{\pi}_\alpha|\tilde{\psi}_n\rangle}
M_{\alpha,\beta}d\langle\tilde{p}_\alpha|\tilde{\psi}_n\rangle
\nonumber\\
&=&
\sum_{\beta,n}
\biggl[\frac{1}{f_n}\sum_{\alpha}
\frac{\partial E}
{\partial \langle\tilde{\pi}_\alpha|\tilde{\psi}_n\rangle}
M_{\alpha,\beta}\biggr]
d\Bigl(\langle\tilde{p}_\alpha|\tilde{\psi}_n\rangle f_n\Bigr)
\end{eqnarray}
Note, that the treatment of the occupations in the last step is only
possible, because wave function and occupations always enter in a
particular combination.  \textbf{Note that f does not enter
  linearly. is the assumption used still correct?}


This operation is performed in
\verb|lmto$projtontbo| with \verb|ID='BACK'|.

%===============================================================================
\subsection{From local-orbital coefficients to the density matrix}
%===============================================================================

%====================================================================
\subsubsection{Bloch theorem revisited}
%====================================================================
The Bloch states are eigenstates of the discrete lattice translation 
\begin{eqnarray}
\hat{S}(\vec{t})=\int d^3r\;|\vec{r}+\vec{t}\rangle\langle\vec{r}|
\end{eqnarray}
for the discrete lattice vectors $\vec{t}$. The eigenvalue equation has the form
\begin{eqnarray}
\hat{S}(\vec{t})|\psi_{\vec{k}}\rangle=|\psi_{\vec{k}}\rangle
\e{i\vec{k}\vec{r}}
\end{eqnarray}
This eigenvalue equation can be recast into the form
\begin{eqnarray}
\langle\vec{r}-\vec{t}|\psi_{\vec{k}}\rangle=\langle\vec{r}|\psi_{\vec{k}}\rangle
\e{i\vec{k}\vec{t}}
\end{eqnarray}
This implies that the states can be written  as product of a periodic function and a phase factor
\begin{eqnarray}
\langle\vec{r}|\psi_{\vec{k}}\rangle=u_{\vec{k}}(\vec{r})\e{i\vec{k}\vec{r}}
\end{eqnarray}
with
\begin{eqnarray}
u_{\vec{k}}(\vec{r})=u_{\vec{k}}(\vec{r}+\vec{t})
\end{eqnarray}

%====================================================================
\subsubsection{Bloch theorem in a local orbital basis}
%====================================================================
With $q_\alpha\defas \langle\pi_\alpha|\psi\rangle$, we obtain
\begin{eqnarray}
\hat{S}(\vec{t})\sum_\alpha|\chi_\alpha\rangle q_{\alpha,n}
&=&
\sum_\alpha|\chi_\alpha\rangle q_{\alpha,n}\e{i\vec{k}_n\vec{t}}
\nonumber\\
\int d^3r\;|\vec{r}+\vec{t}\rangle\langle\vec{r}|
\sum_\alpha|\chi_\alpha\rangle q_{\alpha,n}
&=&
\int d^3r\;|\vec{r}\rangle\langle\vec{r}|
\sum_\alpha|\chi_\alpha\rangle q_{\alpha,n}\e{i\vec{k}_n\vec{t}}
\nonumber\\
\sum_\alpha\langle\vec{r}-\vec{t}|\chi_\alpha\rangle q_{\alpha,n}
&=&
\sum_\alpha
\langle\vec{r}|\chi_\alpha\rangle q_{\alpha,n}\e{i\vec{k}_n\vec{t}}
\nonumber\\
\sum_\alpha\langle\vec{r}|\chi_{\alpha+\vec{t}}\rangle q_{\alpha,n}
&=&
\sum_\alpha
\langle\vec{r}|\chi_\alpha\rangle q_{\alpha,n}\e{i\vec{k}_n\vec{t}}
\nonumber\\
\sum_{\alpha'}\langle\vec{r}|\chi_{\alpha'}\rangle q_{\alpha'-\vec{t},n}
&=&
\sum_\alpha
\langle\vec{r}|\chi_\alpha\rangle q_{\alpha,n}\e{i\vec{k}_n\vec{t}}
\nonumber\\
q_{\alpha+\vec{t},n}&=&q_{\alpha,n}\e{-i\vec{k}_n\vec{t}}
\end{eqnarray}

%====================================================================
\subsubsection{Density matrix}
%====================================================================
\begin{eqnarray}
\rho_{\alpha,\beta+\vec{t}}
&=&
\sum_n \langle\pi_\alpha|\psi_n\rangle f_n
\langle\psi_n|\pi_\beta\rangle
\e{+i\vec{k}_n\vec{t}}
\end{eqnarray}



%====================================================================
\section{Core-valence exchange}
%====================================================================
The exchange term between core and valence electrons acts like a
fixed, nonlocal potential acting on the electrons, of the form
\begin{eqnarray}
\hat{\tilde{v}}_{x,cv}=\sum_{\alpha,\beta}|\tilde{p}_\alpha\rangle 
M_{\alpha,\beta}\langle\tilde{p}_\beta|
\end{eqnarray}
The core-valence exchange is furthermore diagonal in the site indices.

\begin{eqnarray}
\langle\chi_\alpha|\hat{v}_{x,cv}|\chi_\beta\rangle
&=&
\sum_{\gamma,\delta}
\langle\chi_\alpha|p_\gamma\rangle 
M_{\gamma,\delta}\langle p_\delta|\chi_\beta\rangle
\nonumber\\
&=&
\sum_{\gamma,\delta}
\langle\tilde{\phi}^{K}_\alpha|\tilde{p}_\gamma\rangle 
M_{\gamma,\delta}
\langle\tilde{p}_\delta|\tilde{\phi}^{K}_\beta\rangle
\nonumber\\
&-&
\sum_{\gamma,\delta,\beta'}
\langle\tilde{\phi}^{K}_\alpha|\tilde{p}_\gamma\rangle 
M_{\gamma,\delta}
\langle\tilde{p}_\delta|\tilde{\phi}^{\bar{J}}_{\beta'}\rangle 
\bar{S}^\dagger_{\beta',\beta}
\nonumber\\
&-&
\sum_{\gamma,\delta,\alpha',\alpha}
\bar{S}_{\alpha,\alpha'}
\langle\tilde{\phi}^{\bar{J}}_{\alpha'}|\tilde{p}_\gamma\rangle 
M_{\gamma,\delta}
\langle\tilde{p}_\delta|\tilde{\phi}^{K}_{\beta}\rangle 
\nonumber\\
&+&
\sum_{\gamma,\delta,\alpha',\alpha}
\bar{S}_{\alpha,\alpha'}
\langle\tilde{\phi}^{\bar{J}}_{\alpha'}|\tilde{p}_\gamma\rangle 
M_{\gamma,\delta}
\langle\tilde{p}_\delta|\tilde{\phi}^{\bar{J}}_{\beta'}\rangle 
\bar{S}^\dagger_{\beta',\beta}
\end{eqnarray}
Here we used the augmented Hankel and screened Bessel fucntions,
respectively their pseudo versions.

As usual we build the expanded density matrix
\begin{eqnarray}
\left(\begin{array}{cc}
  \mat{\rho} \qquad& 
-\mat{\rho}\mat{\bar{S}}^\dagger\\
-\mat{\bar{S}}\mat{\rho} \qquad& 
\mat{\bar{S}}\mat{\rho}\mat{\bar{S}}^\dagger\\
\end{array}\right)
\end{eqnarray}

The matrix 
\begin{eqnarray}
\left(\begin{array}{cc}
\langle\tilde{\phi}^{K}|\tilde{p}\rangle 
\mat{M}\langle\tilde{p}|\tilde{\phi}^{K}\rangle &
\langle\tilde{\phi}^{K}|\tilde{p}\rangle 
\mat{M}\langle\tilde{p}|\tilde{\phi}^{\bar{J}}\rangle \\
\langle\tilde{\phi}^{\bar{J}}|\tilde{p}\rangle 
\mat{M}\langle\tilde{p}|\tilde{\phi}^{K}\rangle &
\langle\tilde{\phi}^{\bar{J}}|\tilde{p}\rangle 
\mat{M}\langle\tilde{p}|\tilde{\phi}^{\bar{J}}\rangle \\
\end{array}\right)
\end{eqnarray}
is calculated first using \verb|potpar1(isp)%prok| and
\verb|potpar1(isp)%projbar|.
\footnote{ In the earlier version the contribution from the
  $\dot{\bar{\phi}}$ has been ignored!!! It has been verified by
  temporarily switching off the jbar contributiuon to
  potpar1(isp)\%prok and potpar1(isp)\%projbar. In this old version
  only potpar(isp)\%ktophi is used to extract the $\phi$
  contribution.}







%====================================================================
\chapter{Description of Subroutines}
%====================================================================
%====================================================================
\section{LMTO\$STRUCTURECONSTANTS}
%====================================================================
\begin{verbatim}
subroutine lmto$structureconstants(r21,K2,L1x,L2x,S)
REAL(8)   ,INTENT(IN) :: R21(3) ! EXPANSION CENTER
INTEGER(4),INTENT(IN) :: L1X
INTEGER(4),INTENT(IN) :: L2X
REAL(8)   ,INTENT(IN) :: K2 ! 2ME/HBAR**2
REAL(8)   ,INTENT(OUT):: S((L1X+1)**2,(L2X+1)**2)
\end{verbatim}

The bare structure constants are evaluated in 
\verb|LMTO$STRUCTURECONSTANTS| as
\begin{eqnarray}
S_{RL,R'L'}=(-1)^{\ell'+1} 4\pi \sum_{L''} C_{L,L',L''} 
H_{L''}(\vec{R}'-\vec{R})
\kappa^{\ell+\ell'-\ell''}
\end{eqnarray}
where 
\begin{eqnarray}
\kappa=
\begin{cases}
-i\sqrt{k^2} &\text{for $k^2\ge0$}\\
\sqrt{k^2} &\text{for $k^2<0$}\\
\end{cases}
\end{eqnarray}
and where $H_L(k^2,\vec{R})$ is the solid Hankel function calculated
in \verb|LMTO$SOLIDHANKEL|. The solid Hankel function is the solution
of the Helmholt equation\footnote{The factors and signs of the
  inhomogeneity need to be confirmed. The equation has been taken from
  the Methods book chapter ``working with spherical Hankel and Bessel
  functions.}
\begin{eqnarray}
\Bigl[\vec{\nabla^2}+k^2\Bigr]H_{L}(\vec{r})
=-4\pi(-1)^\ell\mathcal{Y}(\vec{\nabla})\delta(\vec{r})
\end{eqnarray}
Here $\mathcal{Y}_\ell(\vec{r})=r^\ell Y_\ell(\vec{r})$ is a
polynomial. With a gradient as argument it becomes a differential
operator.

Near the origin the solid Hankel function behaves, irrespective of the
value of $k^2$ like
\begin{eqnarray}
H_\ell(\vec{r})=(2\ell+1)!! \frac{1}{|\vec{r}|^{\ell+1}}Y_L(\vec{r}) 
\Bigl(1+O(|\vec{r}|)\Bigr)
\end{eqnarray}
More information on the solid Hankel function can be found in
appendix~\ref{app:solidhankel}.


%====================================================================
\section{Waves object}
%====================================================================
The data exchange betweeen the waves object and the lmto object is
determined by the local-orbital projections
$\langle\tilde{\pi}_\alpha|\tilde{\psi}_n\rangle$ specified by the
array \verb|THIS%TBC|, which in turn is obtained from the partial-wave
projections $\langle\tilde{p}|\tilde{\psi}_n\rangle$.



In \verb|waves$etot|
\begin{verbatim}
CALL WAVES$TONTBO
-> CALL LMTO$PROJTONTBO('FWRD'...)
..
..
CALL LMTO$ETOT(LMNXX,NDIMD,NAT,DENMAT)
..
..
CALL WAVES$FROMNTBO()
-> CALL LMTO$PROJTONTBO('BACK'...)
..
..
CALL WAVES$FORCE
-> CALL WAVES_FORCE_ADDHTBC
...
CALL WAVES$HPSI
\end{verbatim}


\begin{eqnarray*}
\vec{F}&=&
-\sum_\alpha
\frac{dE}{d\langle\tilde{p}_\alpha|\psi_n\rangle}
\langle\vec{\nabla}_R\tilde{p}_\alpha|\psi_n\rangle
+\mathrm{c.c.}
\nonumber\\
&=&-\sum_{\alpha,\beta}
\frac{dE}{d\langle\tilde{\pi}_\beta|\psi_n\rangle}
\frac{d\langle\tilde{\pi}_\beta|\psi_n\rangle}
{d\langle\tilde{p}_\alpha|\psi_n\rangle}
\langle\vec{\nabla}_R\tilde{p}_\alpha|\psi_n\rangle
+\mathrm{c.c.}
\nonumber\\
&=&-\sum_{\alpha,\beta}
\frac{dE}{d\langle\tilde{\pi}_\beta|\psi_n\rangle}
\frac{d\langle\tilde{\pi}_\beta|\psi_n\rangle}
{d\langle\tilde{p}_\alpha|\psi_n\rangle}
\Bigl[-\langle\vec{\nabla}_r\tilde{p}_\alpha|\psi_n\rangle\Bigr]
+\mathrm{c.c.}
\end{eqnarray*}





\appendix
%=======================================================================
\chapter{Definition of solid Hankel functions}
\label{app:solidhankel}
%=======================================================================
The solid Hankel function has the form
\begin{eqnarray}
H_L(\vec{R})=Y_L(\vec{R})
\begin{cases}
n_\ell(\sqrt{k^2}\cdot|\vec{R}|) \cdot \sqrt{k^2}^{\ell+1}
&\text{for $k^2>0$  (Abramovitz 10.1.26)}\\
m_\ell(\sqrt{-k^2}\cdot|\vec{R}|) \cdot \sqrt{\frac{2}{\pi}} \sqrt{-k^2}^{\ell+1}
&\text{for $k^2<0$  (Abramovitz 10.2.4)}\\
(2\ell-1)!! |\vec{R}|^{-\ell-1} 
&\text{for $k^2=0$  (Abramovitz 10.2.5)}\\
\end{cases}
\end{eqnarray}
The solid Hankel function is defined such that the boundary conditions
at the origin are independent of $k^2$.

\begin{itemize}
\item the function
\begin{eqnarray}
n_\ell(r)=r^\ell\Bigl(-\frac{1}{r}\partial_r\Bigr)^\ell\frac{1}{r}\cos(r)
\label{eq:defneumann}
\end{eqnarray}
is the spherical Neumann function (see Eq. 8.175 of Cohen Tannoudhi
Band 2), which is also called the spherical Bessel function of the
second kind. Abramowitz defines $n_\ell(r)=-y_\ell(r)$ (compare
Abramowitz Eq. 10.1.26)

The spherical Neumann function obeys the radial Helmholtz equation
(Abramowitz Eq. 10.1.1) for positive kinetic energy
\begin{eqnarray}
r^2\partial^2_r n_\ell+2r\partial_r n_\ell+\Bigl(r^2-\ell(\ell+1)\Bigr) n_\ell=0
\nonumber\\
\Rightarrow\quad
\Bigl[-\frac{1}{r}\partial_r r +\frac{\ell(\ell+1)}{r^2}\Bigr]
n_\ell(r)=+n_\ell(r)
\end{eqnarray}

\textbf{Note that the subroutine SPFUNCTION\$NEUMANN returns the
  Neumann function with the opposite sign, namely what Abramowitz
  defines as Bessel function of the second kind. The minus sign is
  added in the calling routine.}
%
\item The function 
\begin{eqnarray}
m_\ell(r)=r^\ell\Bigl(-\frac{1}{r}\partial_r\Bigr)^\ell\frac{1}{r}\e{-r}
\label{eq:defml}
\end{eqnarray}
used for $k^2<0$ is obeys the radial Helmholtz equation (Abramowitz
Eq. 10.2.1) for negative kinetic energy
\begin{eqnarray}
r^2\partial^2_r m_\ell
+2r\partial_r m_\ell
-\Bigl(r^2+\ell(\ell+1)\Bigr) m_\ell=0
\nonumber\\
\Rightarrow\quad
\Bigl[-\frac{1}{r}\partial_r r +\frac{\ell(\ell+1)}{r^2}\Bigr]
m_\ell(r)=-m_\ell(r)
\end{eqnarray}
They are solutions for negative energy and therefore they fall off
exponentially.  The solution $m_\ell(r)$ is proportional to the
modified spherical Bessel functions of the third kind as defined by
Abramowitz\cite{abramowitz64_book} in their Eq. 10.2.4.
\begin{eqnarray}
m_\ell(r)=\frac{2}{\pi} \Bigl[\sqrt{\frac{\pi}{2r}} K_{\ell+1}(r)\Bigr]
\end{eqnarray}
which can be verified by comparing the defining equation \eq{eq:defml}
with equations 10.2.24-25 and the definition Eq. 10.2.4 of Abramowitz.
\end{itemize}

\clearpage
\bibliographystyle{unsrtnat} \bibliography{../all}
\end{document}  
