\documentclass[11pt,a4paper]{report}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                                                 %%
%%    Header file for the Phi-S-X Series                           %%
%%                                                                 %%
%%    german version header_gm.tex is derived from header.tex      %%
%%    by uncommenting the line ``\setboolean{german}{true}'' below %%
%%                                                                 %%
%%    Never edit the german version! all changes must be done      %%
%%    in the english version header.tex                            %%
%%                                                                 %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{../header}
\hypersetup{pdftitle=paw_brillouin}
\newcommand{\petertt}[1]{\textcolor{red}{\texttt{#1}}}
\makeindex
\begin{document}
\begin{titlepage}
\begin{center}
\vspace*{3.5cm}
{\huge \textbf{The SETUPS object of the CP-PAW code}}\\
\vspace{0.5cm}
{\large Peter E. Bl\"ochl}
\vspace{0.5cm} 
\end{center}

\vfill
\begin{center}
Copyright Peter E. Bl\"ochl; Sept.2, 2013-\today\\
{\small
Institute of Theoretical Physics;
Clausthal University of Technology;\\ 
D-38678 Clausthal Zellerfeld; Germany;\\
http://www.pt.tu-clausthal.de/atp/}
\end{center}
\end{titlepage}
\noindent            
\tableofcontents
%====================================================================
\chapter{Purpose and theoretical background}
%====================================================================
%====================================================================
\section{Nodeless constructiuon}
%====================================================================
%====================================================================
\subsection{Basic definitions}
%====================================================================
%====================================================================
\subsubsection{Energy-dependent partial waves}
%====================================================================
Let us consider a spherical one-particle Hamiltonian $hat{h}$. We
construct energy-dependent partial waves by radially integrating the
radial Schr\"odinger equation 
\begin{eqnarray}
(\hat{h}-\epsilon)|\phi(\epsilon)\rangle=0
\end{eqnarray}
outward with the boundary
conditions 
\begin{eqnarray}
\lim_{|\vec{r}|\rightarrow0}\frac{\phi(\epsilon,\vec{r})}
{|\vec{r}|^\ell Y_{\ell,m}(\vec{r})}
\end{eqnarray}
at the origin.



%====================================================================
\subsubsection{Node-less bound states}
%====================================================================
We define\cite{bloechl12_arxiv1210_5937} a sequence of
\textbf{node-less bound states}\index{node-less bound states}
$|u_n\rangle$
\begin{eqnarray}
(\hat{h}-\epsilon_n)|u_n\rangle=-|u_{n-1}\rangle
\label{eq:nodelesseq}
\end{eqnarray}
The first wave function, $|u_1\rangle$ is the lowest bound state of
the hamiltonian. The other ones are calculated by radially integrating
the Schr\"odinger equation outward, starting with vanishing value and
derivative, so that
\begin{eqnarray}
\lim_{\vec{r}\rightarrow0}|\frac{\langle\vec{r}|u_n\rangle}{|\vec{r}|^{\ell+1}}=0
\qquad\text{for $n>1$}
\end{eqnarray}


The node-less wave functions do not
have any nodes but look like Slater orbitals, in the sense that they
grow at the origin as a power and that they decay exponentially at
large distance. Their behavior at the origin
is\cite{bloechl12_arxiv1210_5937}
\begin{eqnarray}
u_{n}(\vec{r})
=\left(\frac{2m_e}{\hbar^2}\right)^{n-1}
\frac{(2\ell+1)!!}{(\ell-1+2n)!!(2n-2)!!}
|\vec{r}|^{\ell+2(n-1)}Y_{\ell,m}(\vec{r})
\end{eqnarray}
where $Y_{\ell,m}$ is a real spherical harmonics.

The n lowest node-less wave functions span the same Hilbert space as
the n lowest true wave functions. The all-electron wave functions can
be recovered from the node-less wave functions
via\cite{bloechl12_arxiv1210_5937}
\begin{eqnarray}
|\phi_n\rangle=\sum_{m=1}^n|u_m\rangle \prod_{j=1}^{m-1}(\epsilon_j-\epsilon_n)
=\biggl[\sum_{m=1}^n|u_m\rangle 
\prod_{j=m}^{n-1}\frac{1}{(\epsilon_j-\epsilon_n)}
\biggr]\prod_{k=1}^{n-1}(\epsilon_j-\epsilon_n)
\end{eqnarray}

%====================================================================
\subsubsection{Node-reduced partial waves}
%====================================================================
Secondly, we define a sequence of energy-dependent 
\textbf{node-reduced partial wave}
\index{node-reduced partial wave}
through
\begin{eqnarray}
(\hat{h}-\epsilon)|q_n(\epsilon)\rangle=-|u_{n-1}\rangle
\end{eqnarray}
with the boundary conditions
\begin{eqnarray}
\lim_{\vec{r}\rightarrow0}|
\frac{\langle\vec{r}|q_n(\epsilon)\rangle}
{\langle\vec{r}|u_n\rangle}=1
\qquad\text{for $n>1$}
\end{eqnarray}

The node-reduced wave functions have $n-1$ nodes less than the true
wave function. Near the origin, they are very similar to $|u_n\rangle$
over nearly the entire energy range.


The all-electron partial wave can be constructed from the node-reduced
partial wave and the lower node-less bound states
as\cite{bloechl12_arxiv1210_5937}
\begin{eqnarray}
|\phi(\epsilon)\rangle=\biggl[|q_n(\epsilon)\rangle
+\sum_{m=1}^{n-1}|u_m\rangle\prod_{j=m}^{n-1}\frac{1}{\epsilon_j-\epsilon}
\biggr]
\prod_{k=1}^{n-1}(\epsilon_j-\epsilon)
\label{eq:aephifromnodereduced}
\end{eqnarray}


%====================================================================
\subsubsection{Series expansion of the node-reduced partial wave}
%====================================================================
Let us now define a new sequence of nodeless functions via
\begin{eqnarray}
(\hat{h}-\epsilon)|\bar{q}_{n}^{(j)}(\epsilon)\rangle&=&
-|\bar{q}_n^{(j-1)}(\epsilon_{n+j-1})\rangle
\label{eq:qbardiffgl}
\\
(\hat{h}-\epsilon)|\bar{q}_{n}^{(0)}(\epsilon)\rangle&=&-|u_{n-1}\rangle
\end{eqnarray}
which is nearly identical to that of the nodeless equations and that
of the Taylor coefficients.

This sequence can be constructed by the recursive equation
\begin{eqnarray}
|\bar{q}_{n}^{(j+1)}(\epsilon)\rangle&=&
\frac{-1}{\epsilon-\epsilon_{n+j}}
\Bigl(|\bar{q}_n^{(j)}(\epsilon)\rangle
-|\bar{q}_n^{(j)}(\epsilon_{n+j})\rangle\Bigr)
\qquad\text{for $\epsilon\ne\epsilon_{n+j}$}
\nonumber\\
|\bar{q}_{n}^{(j+1)}(\epsilon_{n+j})\rangle&=&
-\left.\partial_\epsilon\right|_{\epsilon_{n+j}}|\bar{q}_n^{(j)}(\epsilon)\rangle
\label{eq:recursionqbar}
\end{eqnarray}

In the special case that all energies $\epsilon_{n+k}$ are chosen
identical this series results in the Taylor expansion coefficients
\begin{eqnarray}
|q_n^{(j)}(\epsilon)\rangle=
\frac{(-1)^j}{j!}\partial_\epsilon^j|q_n(\epsilon)\rangle
\label{eq:taylorexpansioncoefficientsqn}
\end{eqnarray}



\eq{eq:recursionqbar} is shown recursively: We assume that
\eq{eq:qbardiffgl} holds for $j$ and show that  \eq{eq:recursionqbar}
obeys \eq{eq:qbardiffgl} for $j+1$.
\begin{eqnarray}
(\hat{h}-\epsilon)|\bar{q}^{(j+1)}_{n}(\epsilon)\rangle
&\eqrel{eq:recursionqbar}{=}&
\frac{-1}{\epsilon-\epsilon_{n+j}}
\Bigl((\hat{h}-\epsilon)|\bar{q}_n^{(j)}(\epsilon)\rangle
-(\hat{h}-\epsilon_{n+j})|\bar{q}_n^{(j)}(\epsilon_{n+j})\rangle
+(\epsilon-\epsilon_{n+j})|\bar{q}_n^{(j)}(\epsilon_{n+j})\rangle
\Bigr)
\nonumber\\
&\eqrel{eq:qbardiffgl}{=}&
\frac{-1}{\epsilon-\epsilon_n}
\Bigl(
-|\bar{q}_n^{(j-1)}(\epsilon_{n+j-1})\rangle
+|\bar{q}_n^{(j-1)}(\epsilon_{n+j-1})\rangle
+(\epsilon-\epsilon_{n+j})|\bar{q}_n^{(j)}(\epsilon_{n+j})\rangle
\Bigr)
\nonumber\\
&=&
-|\bar{q}_n^{(j)}(\epsilon_{n+j})\rangle
\end{eqnarray}
which is \eq{eq:qbardiffgl} for the next higher value of $j$. This
completes the proof that $|q_{n}^{(j)}(\epsilon)\rangle$ defined in
\eq{eq:qbardiffgl} obeyes the recursion \eq{eq:recursionqbar}.



From this series we can again recover the node-reduced partial wave as
\begin{eqnarray}
|q_n(\epsilon)\rangle&=&|\bar{q}_n^{(0)}(\epsilon)\rangle
\nonumber\\
&=&|\bar{q}_n^{(0)}(\epsilon_n)\rangle
+|\bar{q}_{n}^{(1)}(\epsilon)\rangle(\epsilon_n-\epsilon_)
\nonumber\\
&=&|\bar{q}_n^{(0)}(\epsilon_n)\rangle
+|\bar{q}_{n}^{(1)}(\epsilon_{n+1})\rangle(\epsilon_n-\epsilon)
+|\bar{q}_{n}^{(2)}(\epsilon)\rangle
(\epsilon_{n+1}-\epsilon)(\epsilon_{n}-\epsilon)
\nonumber\\
&=&\sum_{k=0}^{j-1}
|\bar{q}_{n}^{(k)}(\epsilon_{n+k})\rangle
\prod_{m=0}^{k-1}(\epsilon_{n+m}-\epsilon)
+|\bar{q}_n^{(j)}(\epsilon)\rangle
\prod_{m=0}^{j-1}(\epsilon_{n+m}-\epsilon)
\end{eqnarray}

In this derivation, no assumptions have been made regarding the
energies $\epsilon_{n+j}$. Using all energies equal, results in the
Taylor expanstion given above. Using bound state energies in sequence
results in a nodeless construction.

This flexibility can be exploited to set up an expansion with bound
states and with scattering states. This is important if we wish to
describe semi-core states, valence states and scattering states on the
same footing.

From \eq{eq:aephifromnodereduced}, we obtain the expression for the
full energy-dependent wave function.
\begin{eqnarray}
|\phi(\epsilon)\rangle
\frac{1}{\prod_{k=1}^{n-1}(\epsilon_j-\epsilon)}
&=&
\underbrace{
|\bar{q}_n^{(j)}(\epsilon)\rangle
\prod_{m=0}^{j-1}(\epsilon_{n+m}-\epsilon)
+
\sum_{k=0}^{j-1}
|\bar{q}_{n}^{(k)}(\epsilon_{n+k})\rangle
\prod_{m=0}^{k-1}(\epsilon_{n+m}-\epsilon)
}_{|q_n(\epsilon)\rangle}
\nonumber\\
&+&
\underbrace{
\sum_{m=1}^{n-1}|u_m\rangle\prod_{j=m}^{n-1}\frac{1}{\epsilon_j-\epsilon}
}_{\text{core contribution}}
\end{eqnarray}

Interesting is that the energy-dependent function
$|\bar{q}^{(j)}(\epsilon)\rangle$ does not contribute to the full wave
function at the energies $\epsilon_{j}$ of the core states and at the
energies $\epsilon_{n+m}$ with $m<j$.



%====================================================================
\subsection{Augmentation from node-reduced wave functions}
%====================================================================
%====================================================================
\subsubsection{Pseudization}
%====================================================================

The node-reduced wave function have a similar shape over the entire
energy region. This suggests to change them by the same,
energy-independent function $|k\rangle$, because this is likely not to
introduce extra nodes and to produce wave functions that are equally
suited for a plane wave expansion.

Thus we obtain a definition of our pseudo partual waves over the
entire energy region
\begin{eqnarray}
|\tilde{\phi}(\epsilon)\rangle
\frac{1}{\prod_{k=1}^{n-1}(\epsilon_j-\epsilon)}
=|q_n(\epsilon)\rangle+|k\rangle
\end{eqnarray}
Having a well behaved representation of the pseudo partial waves, we
can be quite sure that we do not add ghost states. If each partial
wave is pseudized individually, one easily obtains a polynomial
representation of the energy dependent partial wave that contains
divergences.  The construction of $|k\rangle$ is described in
section~\ref{sec:determinedeltepseudo}.

%====================================================================
\subsubsection{Truncation of the series expansion}
%====================================================================
In order to obtain individual partial waves, we truncate the expansion
for the energy dependent partial wave to $N_j$ terms
\begin{eqnarray}
|\phi(\epsilon)\rangle
\frac{1}{\prod_{k=1}^{n-1}(\epsilon_j-\epsilon)}
&\approx&
\sum_{k=0}^{N_j-1}
|\bar{q}_{n}^{(k)}(\epsilon_{n+k})\rangle
\prod_{m=0}^{k-1}(\epsilon_{n+m}-\epsilon)
+
\underbrace{
\sum_{m=1}^{n-1}|u_m\rangle\prod_{j=m}^{n-1}\frac{1}{\epsilon_j-\epsilon}
}_{\text{core contribution}}
\nonumber\\
|\tilde{\phi}(\epsilon)\rangle\frac{1}{\prod_{k=1}^{n-1}(\epsilon_j-\epsilon)}
&\approx&
\sum_{k=0}^{N_j-1}
|\bar{q}_{n}^{(k)}(\epsilon_{n+k})\rangle
\prod_{m=0}^{k-1}(\epsilon_{n+m}-\epsilon)
+|k\rangle
\end{eqnarray}
This representation of the energy dependent partial wave is exact for
the energies $\epsilon_{n+j}$ for $0\le j\le N_j-1$.

A basis set describing the pseudo partial waves is
\begin{eqnarray}
|\tilde{\phi}^{(0)}\rangle&=&|q_n(\epsilon_n)\rangle+|k\rangle
\nonumber\\
|\tilde{\phi}^{(j)}\rangle&=&|\bar{q}_n^{(j)}(\epsilon_{n+j})\rangle
\qquad\text{for $1\le j\le N_j-1$}
\end{eqnarray}
Note, that only the first pseudo partial wave differs from its
node-reduced partial wave. This is because the difference $|k\rangle$
has been chosen energy independent.

%====================================================================
\subsubsection{Core orthogonalization}
%====================================================================
The all-electron partial waves are obtained from the node-reduced
partial waves $|q_n^{(j)}(\epsilon_{n+j})\rangle$ by explicit
orthogonalization to the nodeless core states. Here we begin to
orthogonalize to the highest core state first and then proceed to the
lowest core state.

Note that we do not include a pseudo core into the pseudo partial
waves even though we currently still define a pseudo core state. The
latter shall be used to construct a pseudo core density.

%====================================================================
\subsubsection{Construction of bare projector functions}
%====================================================================
The projector functions must obey the biorthogonality condition and
the bare projector functions must fulfill the closure relation
\begin{eqnarray}
|\bar{p}^{(j)}\rangle=(\tilde{h}-\epsilon_{n+j})
|\tilde{\phi}(\epsilon_{n+j})\rangle \qquad\text{for $j=0,\ldots,j_x$}
\end{eqnarray}
which implies that the scattering properties shall be exactly obeyed at
the chosen energies $\epsilon_{n+j}$.

The pseudo partial waves at the energies are
\begin{eqnarray}
|\tilde{\phi}(\epsilon_{n+p})\rangle
&=&
\sum_{k=0}^{N_j-1}|\bar{q}_n^{(k)}(\epsilon_{n+k})\rangle
\prod_{m=0}^{k-1}(\epsilon_{n+m}-\epsilon_{n+p})+|k\rangle
\nonumber\\
&=&\sum_{k=0}^{p}|\bar{q}_n^{(k)}(\epsilon_{n+k})\rangle
\prod_{m=0}^{k-1}(\epsilon_{n+m}-\epsilon_{n+p})+|k\rangle
\nonumber\\
&=&\sum_{k=0}^{p}|\tilde{\phi}^{(k)}\rangle
\prod_{m=0}^{k-1}(\epsilon_{n+m}-\epsilon_{n+p})
\end{eqnarray}
This expression holds strictly, but if there are two or more identical
$\epsilon_{n+p}$, there is only a single independent partial wave for
this set of energies. As a result the space of bare projector
functions derived from these partial waves is too small. For each
degenerate set of partial waves we need to introduce first and higher
derivatives of the partial waves.

The bare projector functions are obtained as follows
\begin{eqnarray}
(\hat{\tilde{h}}-\epsilon_{n+p})
|\tilde{\phi}(\epsilon_{n+p})\rangle
&=&\sum_{k=0}^{p}
(\hat{\tilde{h}}-\epsilon_{n+p})
|\tilde{\phi}^{(k)}\rangle
\prod_{m=0}^{k-1}(\epsilon_{n+m}-\epsilon_{n+p})
\nonumber\\
&=&
(\hat{\tilde{h}}-\epsilon_{n})|\tilde{\phi}^{(0)}\rangle
+|\tilde{\phi}^{(0)}\rangle(\epsilon_n-\epsilon_{n+p})
\nonumber\\
&-&
\underbrace{\sum_{k=1}^{p}
\overbrace{|q_n^{(k-1)}(\epsilon_{n+k-1})\rangle
}^{-(\hat{h}-\epsilon_{n+k})|q_n^{(k)}\rangle}
\prod_{m=0}^{k-1}(\epsilon_{n+m}-\epsilon_{n+p})}
_{
\sum_{k=0}^{p-1}
|q_n^{(k)}(\epsilon_{n+k})\rangle(\epsilon_{n+k}-\epsilon_{n+p})
\prod_{m=0}^{k-1}(\epsilon_{n+m}-\epsilon_{n+p})
}
\nonumber\\
&+&\sum_{k=1}^{p-1}
|q_n^{(k)}(\epsilon_{n+k})\rangle(\epsilon_{n+k}-\epsilon_{n+p})
\prod_{m=0}^{k-1}(\epsilon_{n+m}-\epsilon_{n+p})
\nonumber\\
&+&\sum_{k=1}^{p}
(\hat{\tilde{h}}-\hat{h})
|q_n^{(k)}(\epsilon_{n+k})\rangle
\prod_{m=0}^{k-1}(\epsilon_{n+m}-\epsilon_{n+p})
\nonumber\\
&=&
(\hat{\tilde{h}}-\epsilon_{n})|\tilde{\phi}^{(0)}\rangle
+|\tilde{\phi}^{(0)}\rangle(\epsilon_n-\epsilon_{n+p})
-|q_n^{(0)}(\epsilon_{n})\rangle(\epsilon_{n}-\epsilon_{n+p})
\nonumber\\
&+&\sum_{k=1}^{p}
(\hat{\tilde{h}}-\hat{h})
|q_n^{(k)}(\epsilon_{n+k})\rangle
\prod_{m=0}^{k-1}(\epsilon_{n+m}-\epsilon_{n+p})
\nonumber\\
&=&
(\hat{\tilde{h}}-\epsilon_{n})|\tilde{\phi}^{(0)}\rangle
+
\Bigl[|\tilde{\phi}^{(0)}\rangle-|q_n^{(0)}(\epsilon_{n})\rangle\Bigr]
(\epsilon_n-\epsilon_{n+p})
\nonumber\\
&+&\sum_{k=1}^{p}
(\hat{\tilde{h}}-\hat{h})
|q_n^{(k)}(\epsilon_{n+k})\rangle
\prod_{m=0}^{k-1}(\epsilon_{n+m}-\epsilon_{n+p})
\nonumber\\
&=&
(\hat{\tilde{h}}-\epsilon_{n})|\tilde{\phi}^{(0)}\rangle
+
(\epsilon_n-\epsilon_{n+p})
\biggl(
|\tilde{\phi}^{(0)}\rangle-|q_n^{(0)}(\epsilon_{n})\rangle
+(\hat{\tilde{h}}-\hat{h})
|q_n^{(1)}(\epsilon_{n+1})\rangle
\nonumber\\
&+&\sum_{k=2}^{p}
(\hat{\tilde{h}}-\hat{h})
|q_n^{(k)}(\epsilon_{n+k})\rangle
\prod_{m=1}^{k-1}(\epsilon_{n+m}-\epsilon_{n+p})\biggr)
\end{eqnarray}

The bare projector functions can be spanned by the $N_j$ independent functions
\begin{eqnarray}
|\bar{p}^{(0)}\rangle&=&(\hat{\tilde{h}}-\epsilon_{n})|\tilde{\phi}^{(0)}\rangle
\nonumber\\
|\bar{p}^{(1)}\rangle&=&|\tilde{\phi}^{(0)}\rangle-|q_n^{(0)}(\epsilon_n)\rangle
+(\hat{\tilde{h}}-\hat{h})
|q_n^{(1)}(\epsilon_{n+1})\rangle
\nonumber\\
|\bar{p}^{(j)}\rangle&=&(\hat{\tilde{h}}-\hat{h})|q_n^{(j)}(\epsilon_{n+j})\rangle
\qquad\text{for $j\ge2$}
\end{eqnarray}
This selection is independent from the choice of the energies
$\epsilon_{n+p}$ used to define the sequence of node-reduced wave
functions. That is the result is equally valid if all these energies
are identical.


%====================================================================
\subsubsection{Bi-orthogonalization}
%====================================================================
The bi-orthogonalization shall establish 
\begin{eqnarray}
\langle p^{(j)}|\tilde{\phi}^{(j')}\rangle=\delta_{j,j'}
\end{eqnarray}

We do this while maintaining the partial waves, i.e.
\begin{eqnarray}
|p^{(j)}\rangle=\sum_{n}|p'^{(n)}\rangle
\Bigl(\langle p'^{(j)}|\tilde{\phi}^{(n)}\rangle\Bigr)_{n,j}
\end{eqnarray}

\textbf{The biorthogonalization deteriorates quickly, if the number of
  partial waves is increased.}


\petertt{Question: does the integrand for the overlap between
  projector function and partial wave fall off sufficiently fast with
  distance? Note, that the partial waves increase exponentially.}


%====================================================================
\subsubsection{Augmentation contribution to matrix elements}
%====================================================================
\begin{eqnarray}
dO_{\alpha,\beta}&=&\langle\phi_\alpha|\phi_\beta\rangle-
\langle\tilde{\phi}_\alpha|\tilde{\phi}_\beta\rangle
\nonumber\\
dT_{\alpha,\beta}&=&\langle\phi_\alpha|\hat{t}|\phi_\beta\rangle-
\langle\tilde{\phi}_\alpha|\hat{t}|\tilde{\phi}_\beta\rangle
\end{eqnarray}
The calculation of these matrix elements becomes substantially more
involved in the relativistic case.

\petertt{Problem: In order to cancel the tails of the core wave
  functions, the pseudo partial waves must include a pseudo-core
  contribution. This, however, is likely to produce ghost states. A
  remedy could be to change the exponentially increasing behavior of
  the the node-reduced partial waves artificially such that they do no
  more grow. In that case, the pseudo-core contribution would not harm.}

%====================================================================
\subsection{Pseudo wave functions from node-reduced wave functions}
\label{sec:determinedeltepseudo}
%====================================================================
Here, the routine \verb|SETUPS_MAKEPSPHI_MINE| is described. It is used
to construct a pseudo wave function for the lowest node-reduced
partial wave.

Starting from a wave function $\phi(\vec{r})$, which shall be
pseudized, we invert the Schr\"odinger equation to determine
\begin{eqnarray}
v-\epsilon_\nu=
\begin{cases}
-\frac{1}{\phi(\vec{r})}\hat{t}\phi(\vec{r})&\qquad\text{for $r>r_c$.}
\\
-\frac{1}{\phi(\vec{r}_c)}\hat{t}\phi(\vec{r}_c)&\qquad\text{for $r<r_c$.}
\end{cases}
\label{eq:invertschrgl}
\end{eqnarray}
where $r_c$ is the pseudization radius. $\hat{t}|\phi\rangle$ is a
short-hand notation for the result of the kinetic energy operator
acting on the partial wave. In the non-relativistic theory
$\hat{t}=\frac{\hat{\vec{p}}^2}{2m_0}$, while the expression is more
complex in the relativistic theory.

With \eq{eq:invertschrgl}, we obtain a potential that is shallow and
flat inside the pseudization radius. Outside the pseudization radius
it is chosen such that partial wave obeys the non-relativistic
Schr\"odinger equation for this potential.

Now, we derive for this potential the radial wave function and its
first two energy derivatives
\begin{eqnarray}
\Bigl[\frac{\vec{p}^2}{2m_0}+v-\epsilon_\nu\Bigr]|f\rangle&=&0
\nonumber\\
\Bigl[\frac{\vec{p}^2}{2m_0}+v-\epsilon_\nu\Bigr]|\dot{f}\rangle&=&|f\rangle
\nonumber\\
\Bigl[\frac{\vec{p}^2}{2m_0}+v-\epsilon_\nu\Bigr]|\ddot{f}\rangle
&=&2|\dot{f}\rangle
\end{eqnarray}

At the same time we determine 
\begin{eqnarray}
\hat{t}|f\rangle&=&\frac{\hat{\vec{p}}^2}{2m_e}|f\rangle
=-(\epsilon-v)|f\rangle
\nonumber\\
\hat{t}|\dot{f}\rangle&=&\frac{\hat{\vec{p}}^2}{2m_e}|\dot{f}\rangle
=|f\rangle-(\epsilon-v)|\dot{f}\rangle
\nonumber\\
\hat{t}|\ddot{f}\rangle&=&\frac{\hat{\vec{p}}^2}{2m_e}|\dot{f}\rangle
=2|\dot{f}\rangle-(\epsilon-v)|\ddot{f}\rangle
\end{eqnarray}

Finally, we match these three functions onto the node-reduced wave
function so that
\begin{eqnarray}
|\tilde{\phi}\rangle=|f\rangle c_1 
+|\dot{f}\rangle c_2+|\ddot{f}\rangle c_3
\end{eqnarray}
so that value, derivative and (if requested) the kinetic energy
density at the cutoff radius agree.

%====================================================================
\section{Relativistic effects}
%====================================================================
I recommend to read the doctoral thesis entitled ``The ZORA equation''
of Eric van Lenthe\cite{lenthe96_thesis}, if you can get your hands on
it.


%====================================================================
\subsection{Dirac equation}
%====================================================================
We start from the Dirac equation of an electron in an electric field.
First we divide the wave function into an upper part
$\phi=(\Psi_1,\Psi_2)$ and a smaller part $\chi=(\Psi_3,\Psi_4)$
\begin{eqnarray}
\left(\begin{array}{cc}
v-\epsilon &\quad \vec{\sigma}\vec{p}c\\
\vec{\sigma}\vec{p}c &\quad -2m_0c^2+v-\epsilon\end{array}\right)
\left(\begin{array}{c}|\phi\rangle\\|\chi\rangle\end{array}\right)=0
\label{eq:dirac2by2withepsilon}
\end{eqnarray}
where $\epsilon$ is the energy of the electron relative to the
rest-energy $m_0c^2$. $\vec{\sigma}$ is a vector of $2\times2$
matrices formed from the three Pauli matrices
$\sigma_x,\sigma_y,\sigma_z$.

It will be convenient to introduce the function
\begin{eqnarray}
1+D(\vec{r})\defas\Bigl[1+\frac{\epsilon-v(\vec{r})}{2m_0c^2}\Bigr]^{-1}
\end{eqnarray}
so that the Dirac equation obtains the form
\begin{eqnarray}
\left(\begin{array}{cc}
v-\epsilon &\quad \vec{\sigma}\vec{p}c\\
\vec{\sigma}\vec{p}c &\quad \frac{-2m_0c^2}{1+D}\end{array}\right)
\left(\begin{array}{c}|\phi\rangle\\|\chi\rangle\end{array}\right)=0
\label{eq:dirac2by2withepsilonb}
\end{eqnarray}

The small contribution can be extracted from the second equation of
\eq{eq:dirac2by2withepsilonb}
\begin{eqnarray}
|\chi\rangle
=\frac{1}{2m_0c^2+\epsilon-v}
\vec{\sigma}\vec{p}c |\phi\rangle
=\frac{1+D}{2m_0c}
\vec{\sigma}\vec{p} |\phi\rangle
\end{eqnarray}
Thus, the small component can be eliminated from the first equation of
\eq{eq:dirac2by2withepsilonb}, which is turned into a second-order
differential equation for the large component.
\begin{eqnarray}
\Bigl[\vec{\sigma}\vec{p} \frac{1+D}{2m_0}
\vec{\sigma}\vec{p} +v-\epsilon\Bigr]|\phi\rangle=0
\end{eqnarray}

Using the magic equation
\begin{eqnarray}
(\vec{\sigma}\vec{a})(\vec{\sigma}\vec{b})
=\vec{a}\vec{b}+i\vec{\sigma}(\vec{a}\times\vec{b})
\end{eqnarray}
we obtain the form
\begin{eqnarray}
\Bigl[\vec{p} \frac{1+D}{2m_0}\vec{p} 
+i\vec{\sigma} 
\Bigl(\vec{p} \frac{1+D}{2m_0}\times\vec{p} \Bigr)
+v-\epsilon\Bigr]|\phi\rangle=0
\nonumber\\
\Bigl[\frac{1+D}{2m_0}\vec{p}^2-i\frac{\hbar}{2m_0}(\vec{\nabla}D)\vec{p}
+\vec{S}\Bigl(\frac{\vec{\nabla}D}{m_0}\times\vec{p} \Bigr)
+v-\epsilon\Bigr]|\phi\rangle=0
\end{eqnarray}
where $\vec{S}=\frac{\hbar}{2}\vec{\sigma}$ is the spin.  For a
rotationally symmetric $D(\vec{r})$ , we can
introduce the orbit angular momentum $\vec{L}=\vec{r}\times\vec{p}$
and we obtain the Dirac equation in the form
\begin{eqnarray}
\Bigl[
\frac{1+D}{2m_0}\vec{p}^2 
-i\frac{\hbar\partial_rD}{2m_0|\vec{r}|}\vec{r}\vec{p} 
+i\frac{2}{\hbar}\vec{S} 
\Bigl(\frac{\hbar}{i}(\underbrace{\vec{\nabla}\frac{1+D}{2m_0}}
_{\frac{(\partial_r D)}{2m_0}\frac{\vec{r}}{|\vec{r}|}}\times\vec{p} \Bigr)
+v-\epsilon\Bigr]|\phi\rangle=0
\nonumber\\
\Rightarrow\Bigl[
\frac{1+D}{2m_0}\vec{p}^2 
-i\frac{\hbar\partial_rD}{2m_0|\vec{r}|}\vec{r}\vec{p} 
+ \underbrace{\frac{(\partial_r D)}{m_0|\vec{r}|}\vec{S}\vec{L}}_{\text{spin-orbit}}
+v-\epsilon\Bigr]|\phi\rangle=0
\nonumber\\
\end{eqnarray}


%====================================================================
\subsection{Relativistic augmentation}
%====================================================================
It is our goal to separate all relativistic effects out into the
augmentation contribution, so that we need not consider the
relativistic effects in the plane-wave part. The plane-wave part does
not involve large kinetic energies so that their contribution to the
relativistic effects can be ignored with good confidence.

In the PAW method, we make the following Ansatz for the wave function:
\begin{eqnarray}
\left(\begin{array}{c}|\phi\rangle\\|\chi\rangle\end{array}\right)
=
\left(
\begin{array}{c}|\tilde{\psi}\rangle\\\frac{1}{2m_0c}\vec{\sigma}\vec{p}|\tilde\psi\rangle\end{array}\right)
+
\sum_\alpha
\left[
\left(
\begin{array}{c}|\phi_\alpha\rangle\\
\frac{1+D}{2m_0c}\vec{\sigma}\vec{p}|\phi_\alpha\rangle\end{array}\right)
-
\left(
\begin{array}{c}|\tilde{\phi}_\alpha\rangle\\
\frac{1}{2m_0c}\vec{\sigma}\vec{p}|\tilde{\phi}_\alpha\rangle\end{array}\right)
\right]
\langle\tilde{p}_\alpha|\tilde\psi\rangle
\end{eqnarray}
This ansatz ensures that the wave function is continuous--if $D(r)$
vanishes smoothly beyond the augmentation radius--and that all-electron and
pseudo partial waves become identical. 

This mapping from a two-dimensional Pauli spinor onto a four component
spinor wave function is reminiscent of the Foldy-Wouthuysen
transformation\cite{foldy50_pr78_29}, which diagonalizes the matrix
form of the Dirac Hamiltonian.\footnote{Here we distinguish
  $\vec{\sigma}\vec{p}$ and its hermitean conjugate
  $(\vec{\sigma}\vec{p})^\dagger$. This refers to the fact that the
  identity is not valid on a point-per-point basis, but only in
  connection with certain boundary conditions.}
\begin{eqnarray}
\left(\begin{array}{c}\langle\phi|\\
\langle\chi|\end{array}\right)
\left(\begin{array}{cc}
v-\epsilon &\quad (\vec{\sigma}\vec{p}c)^\dagger\\
\vec{\sigma}\vec{p}c &\quad -2m_0c^2+v-\epsilon\end{array}\right)
\left(\begin{array}{c}|\phi\rangle\\|\chi\rangle\end{array}\right)=0
\end{eqnarray}


For the pseudo contribution, we change the all-electron potential to
the pseudo potential $\tilde{v}$ and we set the relativistic factor
$D$ to zero. 

In addition we introduce the small components of the partial waves 
\begin{eqnarray}
|\chi_\alpha\rangle&=&(1+D_\alpha)\frac{\vec{\sigma}\vec{p}}{2m_0c}
|\phi_\alpha\rangle
\nonumber\\
|\tilde{\chi}_\alpha\rangle&=&\frac{\vec{\sigma}\vec{p}}{2m_0c}
|\tilde{\phi}_\alpha\rangle
\end{eqnarray}
The index on the $D_\alpha$ indicates that it has been evaluated with
the energy $\epsilon_\alpha$, the energy used in the nodeless equation
for $|\phi_\alpha\angle$.

For the small pseudo partial wave we made the choice to set $D$ to
zero, while we keep the finite speed of light.


\begin{eqnarray}
\Rightarrow
0&=&\left(\begin{array}{c}\langle\tilde{\psi}|\\
\langle\tilde{\psi}|\frac{(\vec{\sigma}\vec{p})^\dagger}{2m_0c}\end{array}\right)
\left(\begin{array}{cc}
\tilde{v}-\epsilon &\quad (\vec{\sigma}\vec{p}c)^\dagger \\
\vec{\sigma}\vec{p}c &\quad -2m_0c^2+\tilde{v}-\epsilon\end{array}\right)
\left(\begin{array}{c}|\psi\rangle\\
\frac{\vec{\sigma}\vec{p}}{2m_0c}|\tilde{\psi}\rangle\end{array}\right)
\nonumber\\
&+&\sum_{\alpha,\beta}\langle\tilde{\psi}|\tilde{p}_\alpha\rangle
\biggl[
%
\left(\begin{array}{c}\langle\phi_\alpha|\\
\langle\chi_\alpha|
\end{array}\right)
\left(\begin{array}{cc}
v-\epsilon &\quad (\vec{\sigma}\vec{p}c)^\dagger\\
\vec{\sigma}\vec{p}c &\quad -2m_0c^2+v-\epsilon\end{array}\right)
\left(\begin{array}{c}|\phi_\beta\rangle\\
|\chi_\beta\rangle\end{array}\right)
%
\nonumber\\
&&\hspace{2cm}-\left(\begin{array}{c}\langle\tilde{\phi}_\alpha|\\
\langle\tilde{\chi}_\alpha|
\end{array}\right)
\left(\begin{array}{cc}
\tilde{v}-\epsilon &\quad (\vec{\sigma}\vec{p}c)^\dagger\\
\vec{\sigma}\vec{p}c &\quad -2m_0c^2+\tilde{v}-\epsilon\end{array}\right)
\left(\begin{array}{c}|\tilde{\phi}_\beta\rangle\\
|\tilde{\chi}_\beta\rangle\end{array}\right)
%
\biggr]
\langle\tilde{p}_\beta|\tilde{\psi}\rangle
\nonumber\\  %==========================================================
%
&=&\langle\tilde\psi|
\frac{\hat{\vec{p}}^2}{2m_0}+\tilde{v}-\epsilon
+
\underbrace{
\textcolor{red}{(\vec{\sigma}\vec{p})^\dagger
\frac{(\tilde{v}-\epsilon)}{(2m_0c)^2}(\vec{\sigma}\vec{p})}}_{\textrm{ignored}}
|\tilde{\psi}\rangle
\nonumber\\
&+&\sum_{\alpha,\beta}\langle\tilde{\psi}|\tilde{p}_\alpha\rangle
\biggl\lbrace
\underbrace{\Bigl[
\overbrace{
\langle\phi_\alpha|(\vec{\sigma}\vec{p})^\dagger
\frac{1+D_\alpha}{2m_0}
}^{\langle\chi_\alpha|}
(\vec{\sigma}\vec{p})|\phi_\beta\rangle
+\langle\phi_\alpha|
(\vec{\sigma}\vec{p})^\dagger
\overbrace{\frac{1+D_\beta}{2m_0}(\vec{\sigma}\vec{p})
|\phi_\beta\rangle}^{|\chi_\beta\rangle}
-2m_0c^2\langle\chi_\alpha|\chi_\beta\rangle\Bigr]}_{T_{\alpha,\beta}}
\nonumber\\
%
&&\hspace{1.5cm}
-\underbrace{\Bigl[
\overbrace{\langle\tilde{\phi}_\alpha|
(\vec{\sigma}\vec{p})^\dagger\frac{1}{2m_0}
}^{\langle\tilde{\chi}_\alpha|}(\vec{\sigma}\vec{p})
+(\vec{\sigma}\vec{p})^\dagger
\overbrace{
\frac{1}{2m_0}(\vec{\sigma}\vec{p})
|\tilde{\phi}_\beta\rangle}^{|\tilde{\chi}_\beta\rangle}
-2m_0c^2\langle\tilde{\chi}_\alpha
|\tilde{\chi}_\beta\rangle\Bigr]}_{\tilde{T}_{\alpha,\beta}}
\nonumber\\
&&\hspace{1.5cm}+\langle\phi_\alpha|v-\epsilon|\phi_\beta\rangle
+\textcolor{red}{\langle\chi_\alpha|v-\epsilon|\chi_\beta\rangle}
-\langle\tilde{\phi}_\alpha|
\tilde{v}-\epsilon|\tilde{\phi}_\beta\rangle
-
\textcolor{red}{
\langle\tilde{\chi}_\alpha|\tilde{v}-\epsilon|\tilde{\chi}_\beta\rangle}
\biggr\rbrace\langle
\tilde{p}_\beta|\tilde{\psi}\rangle
\end{eqnarray}
We used that $(\vec{\sigma}\vec{p})^2=\vec{p}^2$.

The three terms marked in red are problematic, because
the first one contrbutes to plane wave part. The all-electron term is
not neglegible in the core region, but it also does not vanish in the
tail region, if the partial waves, and with it their small components,
diverge with increasing radius. This diverging part does, however, not
contribute, because it is cancelled by the corresponding one-center
pseudo term. This is also the reason that the pseudo term needs to be
included.

Approximation: 
The pseudo term of the plane wave part, however, is considered to be
small and is ignored in the current implementation. Let us investigate
the size of the error.
\begin{eqnarray*}
\langle\tilde\psi|
(\vec{\sigma}\vec{p})\frac{(\tilde{v}-\epsilon)}{(2m_0c)^2}(\vec{\sigma}\vec{p})
|\tilde{\psi}\rangle &=& \langle\tilde\psi|
\frac{1}{(2m_0c)^2}\frac{\hbar}{i}(\vec{\nabla}\tilde{v})\vec{p}
+\frac{2}{(2m_0c)^2}
\vec{S}\Bigl((\vec{\nabla}\tilde{v})\times\vec{p}\Bigr)
+\frac{(\tilde{v}-\epsilon)}{c^2} \frac{\vec{p}^2}{2m_0}
|\tilde{\psi}\rangle \nonumber\\ &=&
\frac{1}{2m_0c^2}\langle\tilde\psi|
\frac{-i\hbar}{2m_0}(\vec{\nabla}\tilde{v})\vec{p} +\frac{1}{m_0}
\vec{S}\Bigl((\vec{\nabla}\tilde{v})\times\vec{p}\Bigr)
+(\tilde{v}-\epsilon)\vec{p}^2 |\tilde{\psi}\rangle
\end{eqnarray*}


In order to estimate its size let us consider the free electron case,
where the wave functions are simple plane waves.
\begin{eqnarray*}
\langle\tilde\psi|
(\vec{\sigma}\vec{p})\frac{(\tilde{v}-\epsilon)}{(2m_0c)^2}(\vec{\sigma}\vec{p})
|\tilde{\psi}\rangle
&=&\frac{(\hbar\vec{G})^2}{2m_0}\frac{\epsilon-v}{2m_0c^2}
\approx \frac{E_{kin}^2}{2m_0c^2}\approx E^2_{kin} \cdot 2.5
\times10^{-5}\frac{1}{H}
\nonumber\\
&\approx&
\begin{cases}
5.00 mH\cdot N_e &\text{for $E_{kin}=30$~Ry}\\
0.60 mH\cdot N_e &\text{for $E_{kin}=10$~Ry}\\
0.06 mH\cdot N_e &\text{for $E_{kin}=5$~Ry}\\
\end{cases}
\end{eqnarray*}
where $N_e$ is the number of electrons.

Alternatives: Conceivable is to remove the first term from the pseudo
one-center part along with ignoring the complete plane wave part of
the small component. The rational is that this term captures the
dominant term of the pseudo plane wave part, while it does not have
the exponentially increasing behavior that needs to be canceled in the
all-electron term.


Thus we obtain Hamiltonian and overlap matrices of the form
\begin{eqnarray}
\hat{\tilde{T}}&=&
\frac{\hat{\vec{p}}^2}{2m_0}
+\sum_{\alpha,\beta}|\tilde{p}_\alpha\rangle 
dT_{\alpha,\beta}\langle\tilde{p}_\beta|
\nonumber\\
dT_{\alpha,\beta}&=&
\underbrace{
\langle\phi_\alpha|
(\vec{\sigma}\vec{p})\frac{1+D_\alpha}{2m_0}(\vec{\sigma}\vec{p})
}_{\langle g_\alpha|-\langle\phi_\alpha|(v-\epsilon_\alpha)}
|\phi_\beta\rangle
+\langle\phi_\alpha|
\underbrace{(\vec{\sigma}\vec{p})\frac{1+D_\beta}{2m_0}(\vec{\sigma}\vec{p})
|\phi_\beta\rangle}_{|g_\beta\rangle-(v-\epsilon_\beta)|\phi_\beta\rangle}
-2m_0c^2\langle\chi_\alpha|\chi_\beta\rangle
\nonumber\\
&-&
\underbrace{
\langle\tilde{\phi}_\alpha|\frac{\hat{\vec{p}}^2}{2m_0}
}_{\langle \tilde{g}_\alpha|-\langle\tilde{\phi}_\alpha|(\tilde{v}-\epsilon_\alpha)}
|\tilde{\phi}_\beta\rangle
-\langle\tilde{\phi}_\alpha|
\underbrace{
\frac{\hat{\vec{p}}^2}{2m_0}|\tilde{\phi}_\beta\rangle
}_{|\tilde{g}_\beta\rangle-(\tilde{v}-\epsilon_\beta)|\tilde{\phi}_\beta\rangle}
+2m_0c^2\langle\tilde{\chi}_\alpha|\tilde{\chi}_\beta\rangle
\nonumber\\
\hat{\tilde{O}}&=&1+
\sum_{\alpha,\beta}|\tilde{p}_\alpha\rangle dO_{\alpha,\beta}\langle\tilde{p}_\beta|
\nonumber\\
dO_{\alpha,\beta}&=&
\langle\phi_\alpha|\phi_\beta\rangle+\langle\chi_\alpha|\chi_\beta\rangle
-\langle\tilde{\phi}_\alpha|\tilde{\phi}_\beta\rangle
-\langle\tilde{\chi}_\alpha|\tilde{\chi}_\beta\rangle
\nonumber\\
\hat{\tilde{v}}&=&\hat{v}+
\sum_{\alpha,\beta}|\tilde{p}_\alpha\rangle dV_{\alpha,\beta}\langle\tilde{p}_\beta|
\nonumber\\
dV_{\alpha,\beta}&=&
\langle\phi_\alpha|\hat{v}|\phi_\beta\rangle
+\langle\chi_\alpha|\hat{v}|\chi_\beta\rangle
-\langle\tilde{\phi}_\alpha|\tilde{v}|\tilde{\phi}_\beta\rangle
-\langle\tilde{\chi}_\alpha|\tilde{v}|\tilde{\chi}_\beta\rangle
\end{eqnarray}

%====================================================================
\subsection{Nodeless construction for the Dirac equation}
%====================================================================
We generalize \eq{eq:nodelesseq} to the Dirac equation, which yields
\begin{eqnarray}
\left(\begin{array}{cc}
v-\epsilon_n &\quad \vec{\sigma}\vec{p}c\\
\vec{\sigma}\vec{p}c &\quad -2m_0c^2+v-\epsilon_n\end{array}\right)
\left(\begin{array}{c}|u_n\rangle\\|v_n\rangle\end{array}\right)
&=&-\left(\begin{array}{c}|u_{n-1}\rangle\\|v_{n-1}\rangle\end{array}\right)
\end{eqnarray}
where the small component of a nodeless function is denoted by $|v_n\rangle$.

We resolve for the small component $|v_n\rangle$
\begin{eqnarray}
|v_n\rangle=\frac{1+D_n}{2m_0c}(\vec{\sigma}\vec{p})|u_n\rangle
+\frac{1+D_n}{2m_0c^2}|v_{n-1}\rangle
\label{eq:nodelessdiracsmall}
\end{eqnarray}
and insert the result into the first equation
\begin{eqnarray}
(v-\epsilon)|u_n\rangle
+(\vec{\sigma}\vec{p})c|v_n\rangle&=&-|u_{n-1}\rangle 
\nonumber\\
\Bigl[(\vec{\sigma}\vec{p})
\frac{1+D_n}{2m_0}(\vec{\sigma}\vec{p})
+v-\epsilon_n\Bigr]|u_n\rangle
&=&-|u_{n-1}\rangle -(\vec{\sigma}\vec{p})\frac{1+D_n}{2m_0c}|v_{n-1}\rangle
\nonumber\\
\Bigl[
(1+D_n)\frac{\vec{p}^2}{2m_0}
+\frac{\hbar}{i}
\frac{\vec{\nabla}D_n}{2m_0}\vec{p}
+\vec{S}\Bigl(\frac{\vec{\nabla}D_n}{m_0}\times\vec{p}\Bigr)
+v-\epsilon_n\Bigr]|u_n\rangle
&=&-|u_{n-1}\rangle -(\vec{S}\vec{p})\frac{1+D_n}{\hbar m_0c}|v_{n-1}\rangle
\nonumber\\
\label{eq:nodelessdirac1}
\end{eqnarray}


%====================================================================
\subsection{Spinor harmonics}
%====================================================================
For a spherical atom, the spin and orbit angular momenta are no more
conserved independently, but only the total angular momentum is
conserved. Therefore we need to introduce spinor harmonics.

The spinor harmonics obey the eigenvalue equations
\begin{eqnarray}
\left(\hat{\vec{L}}+\hat{\vec{S}}\right)^2|\Omega_{j,\ell,j_z}\rangle
&=&|\Omega_{j,\ell,j_z}\rangle\quad\hbar^2j(j+1)
\\
\hat{\vec{L}}^2|\Omega_{j,\ell,j_z}\rangle
&=&|\Omega_{j,\ell,j_z}\rangle\quad\hbar^2\ell(\ell+1)
\\
\hat{\vec{S}}^2|\Omega_{j,\ell,j_z}\rangle
&=&|\Omega_{j,\ell,j_z}\rangle\quad\hbar^2\frac{3}{4}
\\
\hat{\vec{L}}\hat{\vec{S}}|\Omega_{j,\ell,j_z}\rangle
&=&|\Omega_{j,\ell,j_z}\rangle\quad\hbar^2\frac{1}{2}\left[j(j+1)-\ell(\ell+1)-\frac{3}{4}\right]
\label{eq:lsspinorharmonic}
\\
\left(\hat{L}_z+\hat{S}_z\right)|\Omega_{j,\ell,j_z}\rangle
&=&|\Omega_{j,\ell,j_z}\rangle\quad\hbar(m+\frac{1}{2})
\end{eqnarray}
where the quantum numbers $\kappa$ can assume any value except zero.
\begin{eqnarray}
\kappa&=&\ldots,-2,-1,1,2,\ldots
\\
j_z&=&-|\kappa|+\frac{1}{2},-|\kappa|+\frac{3}{2},\ldots,|\kappa|-\frac{1}{2}
\\
j&=& |\kappa|-\frac{1}{2}
\\
\ell&=&|\kappa+\frac{1}{2}|-\frac{1}{2}
\end{eqnarray}

The spinor harmonics have the form
\begin{eqnarray}
|\chi_{\kappa,j_z}\rangle
\stackrel{\kappa<0}{=}\left(
\begin{array}{c}
|Y_{-\kappa-1,j_z-\frac{1}{2}}\rangle
\sqrt{\frac{-\kappa+j_z-\frac{1}{2}}{-2\kappa-1}}\\
|Y_{-\kappa-1,j_z+\frac{1}{2}}\rangle
\sqrt{\frac{-\kappa-j_z-\frac{1}{2}}{-2\kappa-1}}\end{array}\right)
\qquad
|\chi_{\kappa,j_z}\rangle
\stackrel{\kappa>0}{=}\left(
\begin{array}{c}
-|Y_{\kappa,j_z-\frac{1}{2}}\rangle
\sqrt{\frac{\kappa-j_z+\frac{1}{2}}{2\kappa+1}}\\
|Y_{\kappa,j_z+\frac{1}{2}}\rangle
\sqrt{\frac{\kappa+j_z+\frac{1}{2}}{2\kappa+1}}\end{array}\right)
\label{eq:spinorharmonicskappa_a}
\\
\underbrace{\chi_{-\ell-1,m+\frac{1}{2}}}_{\Omega_{\ell+\frac{1}{2},\ell,m+\frac{1}{2}}}
=\left(
\begin{array}{c}
|Y_{\ell,m}\rangle\sqrt{\frac{\ell+m+1}{2\ell+1}}\\
|Y_{\ell,m+1}\rangle\sqrt{\frac{\ell-m}{2\ell+1}}\end{array}\right)
\qquad
\underbrace{\chi_{\ell,m+\frac{1}{2}}}_{\Omega_{\ell-\frac{1}{2},\ell,m+\frac{1}{2}}}
=\left(
\begin{array}{c}
-|Y_{\ell,m}\rangle\sqrt{\frac{\ell-m}{2\ell+1}}\\
|Y_{\ell,m+1}\rangle\sqrt{\frac{\ell+m+1}{2\ell+1}}\end{array}\right)
\label{eq:spinorharmonicskappa}
\end{eqnarray}

Then spinor harmonics describe states with the spin parallel or
antiparallel to the orbit angular momentum.

%====================================================================
\subsection{Spherical Dirac equations in spinor harmonics}
%====================================================================
The wave function of an electron is a four-component spinor function
consisting of a two-dimensional large and a two-dimensional small
component. Each has again a spin-up and a spin-down component.
\begin{eqnarray}
\left(\begin{array}{c}\phi(\epsilon,\vec{r})\\\chi(\epsilon,\vec{r})
\end{array}\right) =
\left(\begin{array}{c}g_{\kappa,j_z}(\epsilon,\vec{r})
\chi_{\kappa,j_z}(\vec{r})\\ if_{-\kappa,j_z}(\epsilon,\vec{r})
\chi_{-\kappa,j_z}(\vec{r})\\ \end{array}\right) 
\end{eqnarray} 

This Ansatz can be inserted into \eq{eq:nodelessdirac1}
and \eq{eq:nodelessdiracsmall}


\begin{eqnarray}
\Bigl[
(1+D_n)\frac{\vec{p}^2}{2m_0}
+\frac{\hbar}{i}
\frac{\partial_rD_n}{2m_0|\vec{r}}\vec{r}\vec{p}
+\frac{\partial_rD_n}{m_0|\vec{r}|} \vec{S}\underbrace{
\Bigl(\vec{r}\times\vec{p}\Bigr)}_{\vec{L}}
+v-\epsilon_n\Bigr]|u_n\rangle
&=&-|u_{n-1}\rangle -(\vec{S}\vec{p})\frac{1+D_n}{\hbar m_0c}|v_{n-1}\rangle
\nonumber\\
|v_n\rangle=\frac{1+D_n}{2 m_0}
\Bigl[\frac{2}{\hbar c}
(\vec{S}\vec{p})|u_n\rangle
+\frac{1}{c^2}|v_{n-1}\rangle\Bigr]
\end{eqnarray}
which yields with \eq{eq:lsspinorharmonic}

\begin{eqnarray}
&&\hspace{-2cm}\biggl(
(1+D)\frac{-\hbar^2}{2m_0}\biggl(\frac{1}{r}\partial_r^2r
-\frac{\ell(\ell+1)}{r^2}\biggr)
-\frac{\hbar^2(\partial_r D)}{2m_0}
\biggl[\partial_r
+\frac{\kappa+1}{|\vec{r}|}\biggr]
+v-\epsilon \biggr)g^{(n)}_{\kappa,j_z}(\epsilon,r)
\nonumber\\
&=&
-g^{(n-1)}_{\kappa,j_z}(\epsilon_{n-1},r)
+
\frac{\hbar}{c}\biggl[\partial_r+\frac{-\kappa+1}{|\vec{r}|}\biggr]
\frac{1+D}{ 2m_0 }
f_{-\kappa,j_z}^{(n-1)}(\epsilon_{n-1},r)
\nonumber\\
f_{-\kappa,j_Z}^{(n)}(\epsilon,r)
&=&\frac{1+D(\epsilon)}{2 m_0}
\biggl(\frac{\hbar}{c}\biggl[\partial_r+\frac{\kappa+1}{|\vec{r}|}\biggr]
g_{\kappa,j_z}^{(n)}(\epsilon,r)
+
\frac{1}{c^2}f_{-\kappa,j_z}^{(n-1)}(\epsilon_{n-1},r)\biggr)
\end{eqnarray}
Compare with Eq.~5.49-5.51 of the master thesis of Robert
Schade\cite{schade12_thesis}.  (Note, however, that I changed the sign
of $f_{n}$ relative to that of $f_{n-1}$, etc. relative to my earlier
notes.)

%=====================================================================
\chapter{Code structure}
%=====================================================================

%=====================================================================
\section{Setups\_newpro}
%=====================================================================
%=====================================================================
\subsection{Input variables}
%=====================================================================
The major input parameters are:
\begin{center}
\begin{tabular}{|l|l|}
\hline
L    & main angular-momentum quantum number\\
SO   & spin-orbit allignment $\sgn(\vec{S}\vec{L})$ (SO$\in\{-1,0,1\}$)\\
ROUT & bound states are calculates in a box with radius ROUT\\
RC   & cutoff for pseudization of partial waves\\
ENU  & energy for Taylor expansion of partial waves\\
\hline
\end{tabular}
\end{center}

%=====================================================================
\subsection{Flow chart}
%=====================================================================
The flow of the subroutine is as follows:
\begin{enumerate}
\item nodeless core wave functions \verb|UCORE|
\item coefficients \verb|QN| for the expansion of node-reduced partial waves 
\item energy dertivative partial wave of highest partial wave \verb|QNDOT|
\item pseudo core wave functions \verb|PSCORE|
\item pseudo partial waves \verb|PSPHI| (without core tails)
\item all-electron partial waves \verb|AEPHI| by core orthogonalization
\item bare projector functions \verb|PRO|
\item bi-orthogonalization
\item matrix elements \verb|DTKIN| \verb|DOVER|
\end{enumerate}

%=====================================================================
\subsubsection{Pseudo core wave functions}
%=====================================================================
We construct the function
\begin{eqnarray}
f_1&=&r^\ell
\nonumber\\
f_2&=& r^{\ell+2}
\nonumber\\
f_3&=& r^{\ell+4}
\end{eqnarray}
to the nodeless core wave function so that value and derivative agree
at the pseudization radius.

\appendix
%=====================================================================
\chapter{Remarks}
%=====================================================================
\begin{itemize}
\item The small contribution introduces nodes for the nodeless wave
  functions that lie near the nucleus which must not be counted. It is
  a consequence of treating the small component. This is taken care
  off by changing \verb|schroedinger$phaseshift| so that nodes are
  counted starting with a minimum radius. Schade\cite{schade12_thesis}
  gives the minimum radus of 0.07~a$_0$ for the core states and
  0.09~a$_0$ for the valence states.
%
\item Zora avoids the small component.?? Scalar relativistic
  calculations should treat the small component.
%
\item Currently the pseudo partial waves do not contain a pseudo core
  contribution. The pseudo core contribution can introduce ghost
  states.  On the other hand the pseudo core part lets the
  all-electron and pseudo partial waves to deviate at larger
  distances. Does this affect introduce an effect between core states
  and exponentially increasing partial waves?
%
\item The Taylor and the Secant equation are closely related. The
  equations differ only by the value of the chosen energy which is
  $\epsilon_\nu$ in one case and $\epsilon_{n+j}$ in the other. Can
  this be exploited?
%
\item we need a criterion for the quality of the augmentation: The
  Taylor expansion of $|q_n(\epsilon)\rangle$ may have a radially
  dependent convergence radius $\epsilon_c(r)$. For a truncated Taylor
  expansion there is a radius where it is better to leave out a term
  than to include it. Similar problems occur for the secant
  construction usually employed in the PAW method.

  We could use something like
  \begin{eqnarray}
  Q(\epsilon)\defas\min_{\vec{c}}
\sum_n\Bigl|\langle f_n|\Bigl[\tilde{h}-\epsilon+
\sum_\alpha|\tilde{p}_\alpha\rangle(dH_{\alpha,\beta}-\epsilon dO_{\alpha,\beta})
\langle\tilde{p}_\beta|\Bigr]|q'_n(\vec{c},\epsilon)\rangle\Bigr|^2
  \end{eqnarray}
  where $|f_n\rangle$ is some orthonormal basisset and
  $q'_n(\vec{c},\epsilon)\rangle$ is some kind of expansion for the
  partial waves with coefficients $\vec{c}$.
%
\item I need a section about the finite nuclear size
%
\item The fock contribution is not yet included in the new version.
%
\item for a semi-core state one should include a bound state for
  semi-core and for the valence state. The equations are very similar
  so that formulations can be integrated well. 
%
\end{itemize}




%=====================================================================
\chapter{Useful formulas}
%=====================================================================
\begin{eqnarray}
(\vec{\sigma}\vec{a})(\vec{\sigma}\vec{b})
&=&\vec{a}\vec{b}+i\vec{\sigma}(\vec{a}\times\vec{b})
\\
\vec{r}\vec{\sigma}\chi_{\kappa,j_z}&=&-|\vec{r}|\chi_{-\kappa,j_z}
\\
\vec{S}\vec{p}R(|\vec{r}|)\chi_{\kappa,j_z}
&=&\frac{i\hbar^2}{2}\Bigl[\partial_r+\frac{\kappa+1}{|\vec{r}|}\Bigr]
R(|\vec{r}|)\chi_{-\kappa,j_z}
\\
1+D&=&\frac{1}{1+\frac{\epsilon-v}{2m_0c^2}}
\\
\kappa(\ell,so)&=&-1+so\cdot\Bigl(\ell+\frac{so-1}{2}\Bigr)
=
\begin{cases}
-\ell-1&\text{for $\vec{L}\vec{S}\ge0$ .i.e. $so=1$ }\\
\ell&\text{for $\vec{L}\vec{S}<0$ .i.e. $so=-1$}\\
-1&\text{for $\vec{L}\vec{S}=0$ .i.e. $so=0$}\\
\end{cases}
\end{eqnarray}

%=====================================================================
\chapter{Taylor expansion of node-reduced partial waves}
\label{app:tayloraephi} 
%=====================================================================
Here we derive the coefficients $c_{m,j}$ used to determine the Taylor
coeffcieients \eq{eq:taylorexpansioncoefficientsaephi} of the
all-electron partial waves from the nodeless core wave functions and
the Taylor expansion coefficients \eq{eq:taylorexpansioncoefficientsqn}
of the node-reduced wave functions.

\begin{eqnarray}
|\phi_n^{(j)}(\epsilon_\nu)\rangle
&\eqrel{eq:taylorexpansioncoefficientsaephi}{=}&
\frac{(-1)^j}{j!}\left.\partial_\epsilon^{j}\right|_{\epsilon_\nu}
\biggl[|\phi_n(\epsilon)\rangle
\frac{1}{\prod_{k=1}^{n-1}(\epsilon_j-\epsilon)}\biggr]
\nonumber\\
&\eqrel{eq:aephifromnodereduced}{=}&
\frac{(-1)^j}{j!}\left.\partial_\epsilon^{j}\right|_{\epsilon_\nu}
\biggl[
|q_n(\epsilon)\rangle
+\sum_{m=1}^{n-1}|u_m\rangle\prod_{j=m}^{n-1}\frac{1}{\epsilon_j-\epsilon}
\biggr]
\nonumber\\
&\eqrel{eq:taylorexpansioncoefficientsqn}{=}&
|q_n^{(j)}(\epsilon_\nu)\rangle
+\sum_{m=1}^{n-1}|u_m\rangle
\biggl(
\underbrace{\frac{(-1)^j}{j!}\left.\partial_\epsilon^{j}\right|_{\epsilon_\nu}
\biggl[\prod_{j=m}^{n-1}\frac{1}{\epsilon_j-\epsilon}
\biggr]}_{c_{m,j}}\Biggr)
\end{eqnarray}

It is our goal to work out the coeffcients $c_{m,j}$. To explore the
structure of the expressions let us evaluate the first two
derivatives of the product terms
\begin{eqnarray}
\underbrace{\left.\partial_\epsilon^{0}\right|_{\epsilon_\nu}
\biggl[\prod_{j=m}^{n-1}\frac{1}{\epsilon_j-\epsilon}\biggr]}_{b_{m,0}}
&=&
\underbrace{\biggl[\prod_{j=m}^{n-1}\frac{1}{\epsilon_j-\epsilon_\nu}\biggr]
}_{b_{m,0}}
\nonumber\\
\underbrace{\left.\partial_\epsilon^{1}\right|_{\epsilon_\nu}
\biggl[\prod_{j=m}^{n-1}\frac{1}{\epsilon_j-\epsilon}\biggr]}_{b_{m,1}}
&=&\underbrace{\biggl[\prod_{j=m}^{n-1}\frac{1}{\epsilon_j-\epsilon_\nu}\biggr]
}_{b_{m,0}}
\underbrace{\biggl[\sum_{k=m}^{n-1}\frac{1}{\epsilon_j-\epsilon_\nu}\biggr]
}_{a_{m,0}}
\label{eq:taylorphicm1}
\end{eqnarray}
Let us now introduce the new symbols
\begin{eqnarray}
b_{m,j}&\defas&\left.\partial_\epsilon^{j}\right|_{\epsilon_\nu}
\biggl[\prod_{j=m}^{n-1}\frac{1}{\epsilon_j-\epsilon}\biggr]
\nonumber\\
a_{m,j}&\defas&\left.\partial_\epsilon^{j}\right|_{\epsilon_\nu}
\biggl[\sum_{k=m}^{n-1}\frac{1}{\epsilon_j-\epsilon}\biggr]
\end{eqnarray}

Thus we obtain
\begin{eqnarray}
b_{m,1}&=&b_{m,0}a_{m,0}
\nonumber\\
b_{m,2}&=&b_{m,1}a_{m,0}+b_{m,0}a_{m,1}
\nonumber\\
b_{m,2}&=&b_{m,2}a_{m,0}+2b_{m,1}a_{m,1}+b_{m,0}a_{m,2}
\nonumber\\
b_{m,j}&=&\sum_{k=0}^{j-1}\binom{j-1}{k}b_{m,j-k-1}a_{m,k}
\nonumber\\
\underbrace{\frac{(-1)^j}{j!}b_{m,j}}_{c_{m,j}}
&=&
\sum_{k=0}^{j-1}
\frac{(-1)^j}{j!}\underbrace{\frac{j-1)!}{(j-k-1)!k!}}
_{\binom{j-1}{k}}b_{m,j-k-1}a_{m,k}
\nonumber\\
&=&
\sum_{k=0}^{j-1}
\frac{+1}{j}
\underbrace{\Bigl[\frac{(-1)^{j-k-1}}{(j-k-1)!}b_{m,j-k-1}\Bigr]}_{c_{m,j-k-1}}
\Bigl[-\frac{(-1)^k}{k!}a_{m,k}\Bigr]
\end{eqnarray}

The coefficients $a_{m,k}$ are obtained as follows
\begin{eqnarray}
a_{m,j}&=&\left.\partial_\epsilon^{j}\right|_{\epsilon_\nu}
\biggl[\sum_{k=m}^{n-1}\frac{1}{\epsilon_j-\epsilon}\biggr]
=\biggl[\sum_{k=m}^{n-1}\frac{j!}{(\epsilon_j-\epsilon_\nu)^{j+1}}\biggr]
\end{eqnarray}
so that
\begin{eqnarray}
-\frac{(-1)^j}{j!}a_{m,j}&=&
+\sum_{k=m}^{n-1}\frac{1}{(\epsilon_\nu-\epsilon_j)^{j+1}}
\end{eqnarray}

Thus we obtain the following recursive set of equations
\begin{eqnarray}
c_{m,0}&=&\prod_{j=m}^{n-1}\frac{1}{\epsilon_j-\epsilon}
\\
c_{m,j}&=&\frac{1}{j}\sum_{k=0}^{j-1}  c_{m,j-k-1}d_{m,k}
\qquad\text{for $j=1,\ldots,\infty$}
\nonumber\\
d_{m,j}&=&
\biggl[\sum_{k=m}^{n-1}\frac{1}{(\epsilon_j-\epsilon_\nu)^{j+1}}\biggr]
\qquad\text{for $j=0,\ldots,\infty$}
\end{eqnarray}
with which we can evaluate the true wave functions in the form
\begin{eqnarray}
|\phi_n^{(j)}(\epsilon_\nu)\rangle
&=&
|q_n^{(j)}(\epsilon_\nu)\rangle+\sum_{m=1}^{n-1}|u_m\rangle c_{j,m}
\end{eqnarray}

%=====================================================================
\chapter{Derivation of inhomogeneity for the radial Dirac equation}
\label{app:inhomraddirac}
%=====================================================================
Here I make the derivation of the inhomogenity of the radial Dirac
equation very explicit so that one can follow all the signs. This is
because I changed the sign convention of the nodeless construction,
which may cause a mixup with earlier results.

\begin{eqnarray}
&&-|u_{n-1}\rangle-(\vec{S}\vec{p})\frac{1+D}{\hbar m_0c}|v_{n-1}\rangle
\nonumber\\
&&
-g_{\kappa,j_z}^{n-1}-\frac{i\hbar^2}{2}
\Bigl(\partial_r+\frac{1-\kappa}{|\vec{r}|}\Bigr)\frac{1+D}{\hbar m_0c} 
\Bigl(if_{-\kappa,j_z}^{n-1}\Bigr)
\nonumber\\
&&\Bigl(-g_{\kappa,j_z}^{n-1}\Bigr)-\frac{\hbar}{c}
\Bigl(\partial_r+\frac{1-\kappa}{|\vec{r}|}\Bigr)\frac{1+D}{2m_0} 
\Bigl(-f_{-\kappa,j_z}^{n-1}\Bigr)
\end{eqnarray}

\begin{eqnarray}
|v_n\rangle&=&\frac{1+D}{2m}
\Bigl[\frac{2}{\hbar c}(\vec{S}\vec{p})|u_n\rangle+\frac{1}{c}v_n\rangle
\nonumber\\
if_{-\kappa,j_z}^{n}&=&\frac{1+D}{2m}
\Bigl[\frac{2}{\hbar c}\frac{i\hbar^2}{2}
\Bigl[\partial_r+\frac{1+\kappa|}{|\vec{r}|}\Bigr]
g_{\kappa,j_z}^{(n)}
+\frac{1}{c^2}\Bigl(if_{-\kappa,j_z}^{(n)}\Bigr)\Bigr]
\nonumber\\
f_{-\kappa,j_z}^{n}&=&\frac{1+D}{2m}
\Bigl[\frac{\hbar}{c}
\Bigl[\partial_r+\frac{1+\kappa|}{|\vec{r}|}\Bigr]
g_{\kappa,j_z}^{(n)}
+\frac{1}{c^2}\Bigl(f_{-\kappa,j_z}^{(n)}\Bigr)\Bigr]
\nonumber\\
\end{eqnarray}

%=====================================================================
\chapter{Derivatives of node-reduced wave functions}
%=====================================================================

We start from
\begin{eqnarray}
(\hat{h}-\epsilon)|\bar{q}_n^{(j)}(\epsilon)\rangle
&=&-|q_n^{(j-1)}(\epsilon_{n+j-1})\rangle
\end{eqnarray}


\begin{eqnarray}
0
&=&\frac{(-1)^k}{k!}\partial_\epsilon^k
\Bigl[
(\hat{h}-\epsilon)|\bar{q}_n^{(j)}(\epsilon)\rangle
+|q_n^{(j-1)}(\epsilon_{n+j-1})\rangle
\Bigr]
\nonumber\\
&=&\frac{(-1)^k}{k!}\partial_\epsilon^{k-1}
\Bigl[
(\hat{h}-\epsilon)\partial_\epsilon|\bar{q}_n^{(j)}(\epsilon)\rangle
-|\bar{q}_n^{(j)}(\epsilon)\rangle
+\delta_{k,0}|q_n^{(j-1)}(\epsilon_{n+j-1})\rangle
\Bigr]
\nonumber\\
&=&\frac{(-1)^k}{k!}\partial_\epsilon^{k-2}
\Bigl[
(\hat{h}-\epsilon)\partial_\epsilon^2|\bar{q}_n^{(j)}(\epsilon)\rangle
-2\partial_\epsilon|\bar{q}_n^{(j)}(\epsilon)\rangle
+\delta_{k,0}|q_n^{(j-1)}(\epsilon_{n+j-1})\rangle
\Bigr]
\nonumber\\
&=&\frac{(-1)^k}{k!}
\Bigl[
(\hat{h}-\epsilon)\partial_\epsilon^k|\bar{q}_n^{(j)}(\epsilon)\rangle
-k\;\partial_\epsilon^{k-1}|\bar{q}_n^{(j)}(\epsilon)\rangle
+\delta_{k,0}|q_n^{(j-1)}(\epsilon_{n+j-1})\rangle
\Bigr]
\nonumber\\
\nonumber\\
&=&
(\hat{h}-\epsilon)
\Bigl[\frac{(-1)^k}{k!}
\partial_\epsilon^k|\bar{q}_n^{(j)}(\epsilon)\rangle\Bigr]
+
\Bigl[\frac{(-1)^{k-1}}{(k-1)!}\;\partial_\epsilon^{k-1}
|\bar{q}_n^{(j)}(\epsilon)\rangle\Bigr]
+\delta_{k,0}|q_n^{(j-1)}(\epsilon_{n+j-1})\rangle
\end{eqnarray}


Thus we obtain
\begin{eqnarray}
(\hat{h}-\epsilon)
\Bigl[\frac{(-1)^k}{k!}
\partial_\epsilon^k|\bar{q}_n^{(j)}(\epsilon)\rangle\Bigr]
&=&-
\begin{cases}
\Bigl[\frac{(-1)^{k-1}}{(k-1)!}\;\partial_\epsilon^{k-1}
|\bar{q}_n^{(j)}(\epsilon)\rangle\Bigr]&\text{for $k>0$}\\
|q_n^{(j-1)}(\epsilon_{n+j-1})\rangle
&\text{for $k=0$}\\
\end{cases}
\end{eqnarray}



\printindex
\bibliographystyle{unsrtnat}
\bibliography{all}
\end{document}  



