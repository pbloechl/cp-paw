#!/bin/bash
#====================================================================
#  creates the file readpaw.in containing a list of the total energies
#  for all calculatesd systems in Cases
#
#  An entry is prepared for all molecules listed in Samples 
#  fro which a protocoll exists in the corresponding subdirectory 
#  of the directory Cases
#=================================================================
THISDIR=$(pwd)
G1DIR=$THISDIR
SAMPLEDIR=$G1DIR/src/Strcfiles # directory holding the structure files
STPDIR=$G1DIR/src/Speciesfiles # define directory with species information
CASESDIR=$G1DIR/Cases
BINDIR=$G1DIR/bin
#
####################################################################
####################################################################
if [[ ! -d $SAMPLEDIR ]]; then 
   echo "error in $0: SAMPLEDIR does not exist"
   exit 1 
fi
if [[ ! -d $STPDIR ]]; then 
   echo "error in $0: STPDIR does not exist"
   exit 1 
fi
#
#####################################################################
##       compile g2_analyse.f90
#####################################################################
if [[ ! -d $BINDIR ]]; then mkdir $BINDIR ; fi
if [[ ${G1DIR}/src/g2_analyse.f90 -nt ${BINDIR}/g2_analyse.x ]] ; then
  cd $BINDIR
  echo "compiling g2_analyse.f90 ..."
  gfortran -g -o g2_analyse.x ${G1DIR}/src/g2_analyse.f90
  RC=$?
  if [[ $RC != 0 ]] ; then echo "error in $0: compilation failed"; exit 1 ; fi
  cd $THISDIR
fi
#
#####################################################################
## update readpaw.in
#####################################################################
echo "building readpaw.in ..."
if [[ -f readpaw.in ]] ; then rm readpaw.in ; fi
for FILE in ${SAMPLEDIR}/*.strc_sample ; do
  NAME=${FILE%.strc_sample} # strip extension
  NAME=${NAME##*/}          # strip preceeding directories
  DIR=$CASESDIR/$NAME
  if [[  ! -s $DIR ]] ; then
    echo "system $NAME does not exist"
  fi
  X=$(paw_get -n -w etot ${DIR}/$NAME)
  if [[ ! $X  = error* ]] ; then
    echo "  '$NAME' $X " >>${G1DIR}/readpaw.in
  else
    echo "system $NAME produced an error"
  fi
done
#
#####################################################################
##  run analysis
#####################################################################
echo "building readpaw.out ..."
${BINDIR}/g2_analyse.x <readpaw.in >readpaw.out
echo " ...done"
exit 0
